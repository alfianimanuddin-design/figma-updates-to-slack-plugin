<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Design Commit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
            line-height: 1.5;
            color: var(--figma-color-text, #1e1e1e);
            background: var(--figma-color-bg, #ffffff);
            padding: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .container {
            padding: 20px;
            max-width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--figma-color-border, #e5e5e5);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--figma-color-text, #1e1e1e);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .header p {
            font-size: 12px;
            color: var(--figma-color-text-secondary, #6b7280);
            font-weight: 400;
        }

        .server-status {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 11px;
            text-align: center;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .server-status.online {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .server-status.offline {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .setup-section {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .setup-section h4 {
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--figma-color-text, #1e1e1e);
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--figma-color-text, #1e1e1e);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 12px;
            color: var(--figma-color-text, #1e1e1e);
        }

        .form-group .label-hint {
            font-size: 10px;
            color: var(--figma-color-text-secondary, #6b7280);
            font-weight: 400;
            margin-left: 4px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1.5px solid var(--figma-color-border, #e5e5e5);
            border-radius: 8px;
            background: var(--figma-color-bg, #ffffff);
            color: var(--figma-color-text, #1e1e1e);
            font-size: 12px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-field::placeholder {
            color: var(--figma-color-text-tertiary, #9ca3af);
        }

        .textarea-field {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .rich-editor {
            border: 1.5px solid var(--figma-color-border, #e5e5e5);
            border-radius: 8px;
            background: var(--figma-color-bg, #ffffff);
            min-height: 100px;
        }

        .rich-editor:focus-within {
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .editor-toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
            display: flex;
            gap: 4px;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            border-radius: 6px 6px 0 0;
        }

        .editor-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: var(--figma-color-text-secondary, #6b7280);
            transition: all 0.15s ease;
        }

        .editor-btn:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
            color: var(--figma-color-text, #1e1e1e);
        }

        .editor-btn.active {
            background: var(--figma-color-bg-brand, #3b82f6);
            color: white;
        }

        .editor-btn.list-btn {
            padding: 4px 6px;
        }

        .editor-btn svg {
            display: block;
            vertical-align: middle;
        }

        .toolbar-separator {
            color: var(--figma-color-border, #e5e5e5);
            margin: 0 4px;
            font-weight: 300;
        }

        .editor-content {
            padding: 12px;
            min-height: 80px;
            outline: none;
            font-size: 12px;
            line-height: 1.5;
        }

        .editor-content:empty:before {
            content: attr(data-placeholder);
            color: var(--figma-color-text-tertiary, #9ca3af);
            pointer-events: none;
        }

        .commit-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .commit-type-btn {
            padding: 12px 16px;
            border: 1.5px solid var(--figma-color-border, #e5e5e5);
            background: var(--figma-color-bg, #ffffff);
            color: var(--figma-color-text, #1e1e1e);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .commit-type-btn:hover {
            border-color: var(--figma-color-border-brand, #3b82f6);
            background: rgba(59, 130, 246, 0.05);
        }

        .commit-type-btn.active {
            background: var(--figma-color-bg-brand, #3b82f6);
            color: white;
            border-color: var(--figma-color-border-brand, #3b82f6);
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            border: 1.5px solid var(--figma-color-border, #e5e5e5);
            border-radius: 8px;
            background: var(--figma-color-bg, #ffffff);
            min-height: 40px;
            align-items: center;
        }

        .tags-input:focus-within {
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .tag {
            background: var(--figma-color-bg-brand, #3b82f6);
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .tag-input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 11px;
            flex: 1;
            min-width: 80px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--figma-color-bg-brand, #3b82f6) 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .status.loading {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            color: var(--figma-color-text, #1e1e1e);
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .preview-section {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .preview-section h4 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--figma-color-text, #1e1e1e);
        }

        .preview-content {
            background: #36393f;
            color: #dcddde;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #40444b;
        }

        .preview-checkmarks {
            color: #00d26a;
            margin-bottom: 8px;
        }

        .preview-title {
            color: #b9bbbe;
            text-transform: uppercase;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .preview-link {
            color: #00aff4;
            text-decoration: underline;
        }

        .preview-figma {
            color: #ff7262;
            margin: 12px 0;
        }

        .preview-ack {
            color: #dcddde;
            margin-top: 12px;
        }

        .preview-username {
            color: #00aff4;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--figma-color-bg, #ffffff);
            border: 1.5px solid var(--figma-color-border-brand, #3b82f6);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--figma-color-bg-hover, #f3f4f6);
        }

        .autocomplete-item-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--figma-color-text, #1e1e1e);
        }

        .autocomplete-item-username {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-top: 2px;
        }

        .autocomplete-item-role {
            font-size: 10px;
            color: var(--figma-color-text-tertiary, #9ca3af);
            margin-top: 2px;
        }

        .settings-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            border: 1px solid var(--figma-color-border, #e5e5e5);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--figma-color-text, #1e1e1e);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .settings-btn:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
            border-color: var(--figma-color-border-brand, #3b82f6);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: var(--figma-color-bg, #ffffff);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .settings-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--figma-color-text, #1e1e1e);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--figma-color-text-secondary, #6b7280);
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--figma-color-bg-hover, #f3f4f6);
            color: var(--figma-color-text, #1e1e1e);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--figma-color-text, #1e1e1e);
        }

        .settings-section p {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .fetch-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            margin-top: 12px;
        }

        .fetch-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .fetch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .user-count {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            border-radius: 6px;
            text-align: center;
        }

        .user-count.success {
            background: #d1fae5;
            color: #065f46;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            color: #1e40af;
            margin-top: 12px;
            line-height: 1.5;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
        }

        .collapsible-section {
            border: 1px solid var(--figma-color-border, #e5e5e5);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            transition: background 0.2s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
        }

        .collapsible-header h3 {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            color: var(--figma-color-text, #1e1e1e);
        }

        .collapsible-arrow {
            font-size: 12px;
            transition: transform 0.2s ease;
            color: var(--figma-color-text-secondary, #6b7280);
        }

        .collapsible-section.expanded .collapsible-arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: var(--figma-color-bg, #ffffff);
        }

        .collapsible-section.expanded .collapsible-content {
            max-height: 1000px;
        }

        .collapsible-inner {
            padding: 16px;
        }
    </style>
</head>
<body>
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>

    <div class="container">
        <div class="header">
            <h1>
                <span>üé®</span>
                Design Commit
            </h1>
            <p>Professional design handoff automation</p>
        </div>


        <div class="form-section">
            <h3>üìã Project Information</h3>

            <div class="form-group">
                <label>Commit Type</label>
                <div class="commit-types">
                    <button type="button" class="commit-type-btn" data-type="feat">
                        ‚ú® Feature
                    </button>
                    <button type="button" class="commit-type-btn" data-type="fix">
                        üêõ Fix
                    </button>
                    <button type="button" class="commit-type-btn" data-type="update">
                        üîÑ Update
                    </button>
                    <button type="button" class="commit-type-btn active" data-type="final">
                        üéØ Final
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="taskName">Task Name <span class="label-hint">(will appear in title)</span></label>
                <input type="text" id="taskName" class="input-field"
                       placeholder="Personalized Information on IBKR" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="clickupLink">ClickUp Task Link</label>
                    <input type="url" id="clickupLink" class="input-field"
                           placeholder="https://app.clickup.com/t/..." required>
                </div>

                <div class="form-group">
                    <label for="figmaLink">Figma Project Link</label>
                    <input type="url" id="figmaLink" class="input-field"
                           placeholder="https://www.figma.com/file/..." required>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>üìù Description</h3>
            <div class="form-group">
                <label>Description</label>
                <div class="rich-editor">
                    <div class="editor-toolbar">
                        <button type="button" class="editor-btn" data-command="bold" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="editor-btn" data-command="italic" title="Italic">
                            <em>I</em>
                        </button>
                        <button type="button" class="editor-btn" data-command="underline" title="Underline">
                            <u>U</u>
                        </button>
                        <button type="button" class="editor-btn" data-command="strikeThrough" title="Strikethrough">
                            <s>S</s>
                        </button>
                        <span class="toolbar-separator">|</span>
                        <button type="button" class="editor-btn list-btn" data-command="insertOrderedList" title="Numbered List">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <text x="1" y="5" font-size="6" fill="currentColor">1.</text>
                                <line x1="5" y1="4" x2="14" y2="4" stroke="currentColor" stroke-width="1"/>
                                <text x="1" y="10" font-size="6" fill="currentColor">2.</text>
                                <line x1="5" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1"/>
                                <text x="1" y="15" font-size="6" fill="currentColor">3.</text>
                                <line x1="5" y1="14" x2="14" y2="14" stroke="currentColor" stroke-width="1"/>
                            </svg>
                        </button>
                        <button type="button" class="editor-btn list-btn" data-command="insertUnorderedList" title="Bullet List">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <circle cx="2.5" cy="3.5" r="1.5" fill="currentColor"/>
                                <line x1="5" y1="4" x2="14" y2="4" stroke="currentColor" stroke-width="1"/>
                                <circle cx="2.5" cy="8.5" r="1.5" fill="currentColor"/>
                                <line x1="5" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1"/>
                                <circle cx="2.5" cy="13.5" r="1.5" fill="currentColor"/>
                                <line x1="5" y1="14" x2="14" y2="14" stroke="currentColor" stroke-width="1"/>
                            </svg>
                        </button>
                    </div>
                    <div id="descriptionEditor" class="editor-content" contenteditable="true" 
                         data-placeholder="The design for this task has been completed, covering all necessary cases (for this phase). You can access the design on Figma through the following link:"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>üë• Acknowledgments</h3>
            <div class="form-group">
                <label>Acknowledged by <span class="label-hint">(Start typing to search)</span></label>
                <div class="autocomplete-container">
                    <div class="tags-input" id="acknowledgedByTags">
                        <input type="text" id="acknowledgedByInput" class="tag-input"
                               placeholder="Type name or username..." autocomplete="off">
                    </div>
                    <div class="autocomplete-dropdown" id="acknowledgedByDropdown"></div>
                </div>
            </div>

            <div class="form-group">
                <label>CC <span class="label-hint">(optional - people to CC in the message)</span></label>
                <div class="autocomplete-container">
                    <div class="tags-input" id="ccTags">
                        <input type="text" id="ccInput" class="tag-input"
                               placeholder="Type name or username..." autocomplete="off">
                    </div>
                    <div class="autocomplete-dropdown" id="ccDropdown"></div>
                </div>
            </div>
        </div>

        <button type="button" class="submit-btn" id="submitBtn" onclick="commitToSlack()">
            üöÄ Send Design Commit
        </button>

        <div class="preview-section">
            <h4>üìã Preview</h4>
            <div id="previewContent" class="preview-content">
                Fill out the form above to see the preview...
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>

            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>üë• Fetch Slack Users</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 12px; line-height: 1.5;">
                            Enter your Slack Bot Token to fetch all users from your workspace. This will update the autocomplete list with current team members.
                        </p>

                        <div class="form-group">
                            <label for="slackToken">Slack Bot Token</label>
                            <input type="password" id="slackToken" class="input-field"
                                   placeholder="xoxb-your-bot-token-here">
                        </div>

                        <button class="fetch-btn" id="fetchUsersBtn" onclick="fetchSlackUsers()">
                            üîÑ Fetch Users from Slack
                        </button>

                        <div id="userCount" class="user-count" style="display: none;"></div>

                        <div class="info-box">
                            <strong>How to get your Slack Bot Token:</strong>
                            1. Go to <a href="https://api.slack.com/apps" target="_blank">api.slack.com/apps</a><br>
                            2. Select your app or create a new one<br>
                            3. Go to "OAuth & Permissions"<br>
                            4. Add scopes: <code>users:read</code> and <code>users:read.email</code><br>
                            5. Install app to your workspace<br>
                            6. Copy the "Bot User OAuth Token"
                        </div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--figma-color-border, #e5e5e5);">
                            <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--figma-color-text, #1e1e1e);">Current Status</h4>
                            <p id="currentUsersCount" style="font-size: 11px; margin: 0;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>üîß Server Configuration</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 12px; line-height: 1.5;">
                            Configure your Vercel server URL for sending messages to Slack.
                        </p>

                        <div class="form-group">
                            <label for="serverUrl">Vercel Server URL</label>
                            <input type="text" id="serverUrl" class="input-field"
                                   placeholder="https://your-app.vercel.app"
                                   value="https://figma-slack-bridge.vercel.app">
                        </div>

                        <div id="serverStatus" class="server-status" style="display: block;">
                            üîÑ Checking server connection...
                        </div>

                        <div class="info-box">
                            <strong>Server URL:</strong>
                            Enter the URL of your Vercel deployment. This server acts as a proxy to send messages to Slack.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedCommitType = 'final';
        let serverOnline = false;
        let acknowledgedBy = [];
        let ccUsers = [];
        let slackUsers = [];
        let currentFocusIndex = -1;
        let currentDropdownType = null; // 'acknowledged' or 'cc'

        // Initialize
        window.onload = function() {
            loadSlackUsers();
            setupEventListeners();
            checkServerStatus();
            updatePreview();
            updateCurrentUsersCount();
        };

        // Load Slack users from JSON file or Figma storage
        async function loadSlackUsers() {
            try {
                // Try to load from JSON file first
                const response = await fetch('slack-users.json');
                const data = await response.json();
                slackUsers = data.users || [];
                console.log('Loaded', slackUsers.length, 'Slack users from JSON');
                updateCurrentUsersCount();
            } catch (error) {
                console.error('Error loading Slack users from JSON:', error);

                // Fallback to Figma storage
                try {
                    parent.postMessage({ pluginMessage: { type: 'load-slack-users' } }, '*');
                } catch (storageError) {
                    console.error('Error loading from Figma storage:', storageError);
                    slackUsers = [];
                    updateCurrentUsersCount();
                }
            }
        }

        // Listen for messages from plugin code
        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'load-slack-users-success') {
                if (msg.data && msg.data.users) {
                    slackUsers = msg.data.users;
                    console.log('Loaded', slackUsers.length, 'Slack users from Figma storage');
                } else {
                    slackUsers = [];
                }
                updateCurrentUsersCount();
            } else if (msg.type === 'load-slack-users-error') {
                console.error('Error loading from Figma storage:', msg.error);
                slackUsers = [];
                updateCurrentUsersCount();
            } else if (msg.type === 'save-slack-users-success') {
                console.log('Successfully saved Slack users to Figma storage');
            } else if (msg.type === 'save-slack-users-error') {
                console.error('Error saving to Figma storage:', msg.error);
            }
        };

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function toggleCollapsible(header) {
            const section = header.parentElement;
            section.classList.toggle('expanded');
        }

        function updateCurrentUsersCount() {
            const countEl = document.getElementById('currentUsersCount');
            if (slackUsers.length > 0) {
                countEl.textContent = `Currently loaded: ${slackUsers.length} users`;
                countEl.style.color = '#065f46';
            } else {
                countEl.textContent = 'No users loaded. Please fetch users from Slack.';
                countEl.style.color = '#dc2626';
            }
        }

        // Fetch Slack Users
        async function fetchSlackUsers() {
            const token = document.getElementById('slackToken').value.trim();
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const fetchBtn = document.getElementById('fetchUsersBtn');
            const userCountEl = document.getElementById('userCount');

            if (!token) {
                userCountEl.textContent = '‚ö†Ô∏è Please enter your Slack Bot Token';
                userCountEl.style.display = 'block';
                userCountEl.className = 'user-count';
                return;
            }

            if (!token.startsWith('xoxb-')) {
                userCountEl.textContent = '‚ö†Ô∏è Token should start with "xoxb-"';
                userCountEl.style.display = 'block';
                userCountEl.className = 'user-count';
                return;
            }

            if (!serverUrl) {
                userCountEl.textContent = '‚ö†Ô∏è Please configure your Server URL in settings';
                userCountEl.style.display = 'block';
                userCountEl.className = 'user-count';
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ Fetching users...';
            userCountEl.style.display = 'block';
            userCountEl.textContent = 'Connecting to Slack via proxy...';
            userCountEl.className = 'user-count';

            try {
                // Call Vercel proxy endpoint instead of Slack API directly
                const response = await fetch(`${serverUrl}/api/fetch-slack-users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || result.details || 'Failed to fetch users');
                }

                const userData = result.data;
                const users = userData.users;

                if (!users || users.length === 0) {
                    throw new Error('No users found');
                }

                // Save to Figma storage
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-slack-users',
                        data: userData
                    }
                }, '*');

                // Update the current users list
                slackUsers = users;

                userCountEl.textContent = `‚úÖ Successfully fetched ${users.length} users!`;
                userCountEl.className = 'user-count success';

                updateCurrentUsersCount();

                // Show success message
                setTimeout(() => {
                    userCountEl.textContent = `Users have been saved. You can now use autocomplete with ${users.length} team members.`;
                }, 2000);

            } catch (error) {
                console.error('Error fetching users:', error);
                userCountEl.textContent = `‚ùå Error: ${error.message}`;
                userCountEl.className = 'user-count';

                if (error.message === 'invalid_auth' || error.message === 'not_authed') {
                    userCountEl.textContent += ' - Check if your token is correct and the app is installed.';
                } else if (error.message === 'missing_scope') {
                    userCountEl.textContent += ' - Add required scopes: users:read, users:read.email';
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîÑ Fetch Users from Slack';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('settingsModal');
            if (e.target === modal) {
                closeSettings();
            }
        });

        function setupEventListeners() {
            // Commit type selection
            document.querySelectorAll('.commit-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.commit-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCommitType = this.dataset.type;
                    updatePreview();
                });
            });

            // Rich text editor
            document.querySelectorAll('.editor-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.execCommand(command, false, null);
                    document.getElementById('descriptionEditor').focus();
                });
            });

            // Tags input for acknowledged by
            const tagInput = document.getElementById('acknowledgedByInput');
            tagInput.addEventListener('input', function(e) {
                showAutocomplete(this.value, 'acknowledged');
            });
            tagInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, 'acknowledged');
            });
            tagInput.addEventListener('blur', function() {
                setTimeout(() => hideAutocomplete('acknowledged'), 200);
            });

            // Tags input for CC
            const ccInput = document.getElementById('ccInput');
            ccInput.addEventListener('input', function(e) {
                showAutocomplete(this.value, 'cc');
            });
            ccInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, 'cc');
            });
            ccInput.addEventListener('blur', function() {
                setTimeout(() => hideAutocomplete('cc'), 200);
            });

            // Server URL change
            document.getElementById('serverUrl').addEventListener('blur', checkServerStatus);

            // Update preview on input changes
            ['taskName', 'clickupLink', 'figmaLink'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });

            document.getElementById('descriptionEditor').addEventListener('input', updatePreview);

            // Keyboard shortcuts for rich text editor
            document.getElementById('descriptionEditor').addEventListener('keydown', function(e) {
                // Check for CMD (Mac) or CTRL (Windows/Linux)
                const isMod = e.metaKey || e.ctrlKey;

                if (isMod) {
                    switch(e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            document.execCommand('bold', false, null);
                            break;
                        case 'i':
                            e.preventDefault();
                            document.execCommand('italic', false, null);
                            break;
                        case 'u':
                            e.preventDefault();
                            document.execCommand('underline', false, null);
                            break;
                    }
                }
            });
        }

        function addAcknowledgedBy(username) {
            if (username && !acknowledgedBy.includes(username)) {
                acknowledgedBy.push(username);
                renderAcknowledgedByTags();
            }
        }

        function removeAcknowledgedBy(username) {
            acknowledgedBy = acknowledgedBy.filter(u => u !== username);
            renderAcknowledgedByTags();
            updatePreview();
        }

        function addCcUser(username) {
            if (username && !ccUsers.includes(username)) {
                ccUsers.push(username);
                renderCcTags();
            }
        }

        function removeCcUser(username) {
            ccUsers = ccUsers.filter(u => u !== username);
            renderCcTags();
            updatePreview();
        }

        function renderAcknowledgedByTags() {
            const container = document.getElementById('acknowledgedByTags');
            const input = document.getElementById('acknowledgedByInput');
            
            // Clear existing tags
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before input
            acknowledgedBy.forEach(username => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    @${username}
                    <button type="button" class="tag-remove" onclick="removeAcknowledgedBy('${username}')">&times;</button>
                `;
                container.insertBefore(tag, input);
            });
        }

        function renderCcTags() {
            const container = document.getElementById('ccTags');
            const input = document.getElementById('ccInput');

            // Clear existing tags
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before input
            ccUsers.forEach(username => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    @${username}
                    <button type="button" class="tag-remove" onclick="removeCcUser('${username}')">&times;</button>
                `;
                container.insertBefore(tag, input);
            });
        }

        // Autocomplete functions
        function showAutocomplete(query, type) {
            currentDropdownType = type;
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');

            if (!query.trim()) {
                hideAutocomplete(type);
                return;
            }

            // Filter users based on query
            const queryLower = query.toLowerCase();
            const filteredUsers = slackUsers.filter(user => {
                return user.name.toLowerCase().includes(queryLower) ||
                       user.username.toLowerCase().includes(queryLower) ||
                       (user.email && user.email.toLowerCase().includes(queryLower));
            });

            if (filteredUsers.length === 0) {
                hideAutocomplete(type);
                return;
            }

            // Render dropdown items
            dropdown.innerHTML = filteredUsers.map((user, index) => `
                <div class="autocomplete-item" data-index="${index}" onclick="selectUser('${user.username}', '${type}')">
                    <div class="autocomplete-item-name">${user.name}</div>
                    <div class="autocomplete-item-username">@${user.username}</div>
                    ${user.role ? `<div class="autocomplete-item-role">${user.role}</div>` : ''}
                </div>
            `).join('');

            dropdown.classList.add('show');
            currentFocusIndex = -1;
        }

        function hideAutocomplete(type) {
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');
            dropdown.classList.remove('show');
            currentFocusIndex = -1;
        }

        function handleAutocompleteKeydown(e, type) {
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');
            const input = type === 'acknowledged'
                ? document.getElementById('acknowledgedByInput')
                : document.getElementById('ccInput');

            if (!dropdown.classList.contains('show')) {
                if (e.key === 'Enter' && input.value.trim()) {
                    e.preventDefault();
                    if (type === 'acknowledged') {
                        addAcknowledgedBy(input.value.trim());
                    } else {
                        addCcUser(input.value.trim());
                    }
                    input.value = '';
                    updatePreview();
                }
                return;
            }

            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentFocusIndex = (currentFocusIndex + 1) % items.length;
                updateAutocompleteSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentFocusIndex = currentFocusIndex <= 0 ? items.length - 1 : currentFocusIndex - 1;
                updateAutocompleteSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocusIndex >= 0 && items[currentFocusIndex]) {
                    items[currentFocusIndex].click();
                } else if (input.value.trim()) {
                    if (type === 'acknowledged') {
                        addAcknowledgedBy(input.value.trim());
                    } else {
                        addCcUser(input.value.trim());
                    }
                    input.value = '';
                    hideAutocomplete(type);
                    updatePreview();
                }
            } else if (e.key === 'Escape') {
                hideAutocomplete(type);
            }
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === currentFocusIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectUser(username, type) {
            if (type === 'acknowledged') {
                addAcknowledgedBy(username);
                document.getElementById('acknowledgedByInput').value = '';
                hideAutocomplete('acknowledged');
            } else {
                addCcUser(username);
                document.getElementById('ccInput').value = '';
                hideAutocomplete('cc');
            }
            updatePreview();
        }

        async function checkServerStatus() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const statusDiv = document.getElementById('serverStatus');
            
            if (!serverUrl) {
                statusDiv.textContent = '‚ö†Ô∏è Please enter your Vercel URL';
                statusDiv.className = 'server-status offline';
                return;
            }

            try {
                const healthUrl = `${serverUrl}/api/send-to-slack`;
                const response = await fetch(healthUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status && data.status.includes('running')) {
                        serverOnline = true;
                        statusDiv.textContent = '‚úÖ Server online - Ready to commit!';
                        statusDiv.className = 'server-status online';
                    } else {
                        throw new Error('Invalid response');
                    }
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                serverOnline = false;
                statusDiv.textContent = '‚ùå Server offline - Check your Vercel URL';
                statusDiv.className = 'server-status offline';
            }
        }

        function updatePreview() {
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();
            const description = document.getElementById('descriptionEditor').textContent.trim();

            const commitTypes = {
                feat: 'New feature for',
                fix: 'Bug fix for',
                update: 'Update for',
                final: 'Final design for'
            };

            let preview = '';

            // Checkmarks for final design (show standard emoji in preview)
            if (selectedCommitType === 'final') {
                preview += '<div class="preview-checkmarks">‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ</div>';
            }
            
            // Title - show the task name as clickable link if ClickUp link exists
            let titleDisplay = '';
            if (taskName) {
                if (clickupLink) {
                    titleDisplay = `<span class="preview-link">${taskName}</span>`;
                } else {
                    titleDisplay = taskName;
                }
            } else {
                titleDisplay = '[Task Name]';
            }
            preview += `<div class="preview-title">${commitTypes[selectedCommitType]}: ${titleDisplay}</div>`;

            // Description
            preview += `<div>${description || '[Description will appear here]'}</div>`;

            // Figma link - show "Figma file" as clickable link
            let figmaDisplay = '';
            if (figmaLink) {
                figmaDisplay = `<span class="preview-link">Figma file</span>`;
            } else {
                figmaDisplay = 'Figma file';
            }
            preview += `<div class="preview-figma">üé® : ${figmaDisplay}</div>`;

            // Acknowledgments
            let ackText = '';
            if (acknowledgedBy.length > 0) {
                const ackUsers = acknowledgedBy.map(u => `<span class="preview-username">@${u}</span>`).join(' ');
                ackText += `This final design has been acknowledged by ${ackUsers},`;

                // Add CC if present
                if (ccUsers.length > 0) {
                    const ccUsersText = ccUsers.map(u => `<span class="preview-username">@${u}</span>`).join(' ');
                    ackText += ` cc ${ccUsersText}`;
                }
            } else {
                ackText = 'This final design has been acknowledged by: [No acknowledgments yet]';
            }
            
            preview += `<div class="preview-ack">${ackText}</div>`;

            document.getElementById('previewContent').innerHTML = preview;
        }

        function convertHtmlToSlackMarkdown(element) {
            // Clone the element to avoid modifying the original
            const clone = element.cloneNode(true);

            // Convert ordered lists
            const ols = clone.querySelectorAll('ol');
            ols.forEach(ol => {
                const listItems = ol.querySelectorAll('li');
                let listText = '\n';
                listItems.forEach((li, index) => {
                    listText += `${index + 1}. ${li.textContent.trim()}\n`;
                });
                ol.replaceWith(document.createTextNode(listText));
            });

            // Convert unordered lists
            const uls = clone.querySelectorAll('ul');
            uls.forEach(ul => {
                const listItems = ul.querySelectorAll('li');
                let listText = '\n';
                listItems.forEach(li => {
                    listText += `‚Ä¢ ${li.textContent.trim()}\n`;
                });
                ul.replaceWith(document.createTextNode(listText));
            });

            // Convert strikethrough
            const strikes = clone.querySelectorAll('s, strike, del');
            strikes.forEach(s => {
                s.replaceWith(document.createTextNode(`~${s.textContent}~`));
            });

            // Convert bold
            const bolds = clone.querySelectorAll('b, strong');
            bolds.forEach(b => {
                b.replaceWith(document.createTextNode(`*${b.textContent}*`));
            });

            // Convert italic
            const italics = clone.querySelectorAll('i, em');
            italics.forEach(i => {
                i.replaceWith(document.createTextNode(`_${i.textContent}_`));
            });

            // Convert underline (Slack doesn't support underline, so we'll just keep the text)
            const underlines = clone.querySelectorAll('u');
            underlines.forEach(u => {
                u.replaceWith(document.createTextNode(u.textContent));
            });

            return clone.textContent.trim();
        }

        async function commitToSlack() {
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();
            const serverUrl = document.getElementById('serverUrl').value.trim();

            if (!taskName) {
                showStatus('Please enter a task name', 'error');
                return;
            }

            if (!clickupLink) {
                showStatus('Please enter a ClickUp task link', 'error');
                return;
            }

            if (!figmaLink) {
                showStatus('Please enter a Figma link', 'error');
                return;
            }

            if (!serverUrl) {
                showStatus('Please enter your Vercel URL', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üöÄ Sending to Slack...';
            
            showStatus('Sending professional design commit...', 'loading');

            try {
                // Convert HTML to Slack markdown format
                const descriptionEditor = document.getElementById('descriptionEditor');
                const description = convertHtmlToSlackMarkdown(descriptionEditor);
                const webhookUrl = 'WEBHOOK_URL_PLACEHOLDER';

                const commitTypes = {
                    feat: 'NEW FEATURE FOR',
                    fix: 'BUG FIX FOR', 
                    update: 'UPDATE FOR',
                    final: 'FINAL DESIGN FOR'
                };

                // Build title with optional ClickUp link
                let titleText = '';
                if (taskName) {
                    if (clickupLink) {
                        // Ensure proper URL format
                        const formattedClickupLink = clickupLink.startsWith('http') ? clickupLink : `https://${clickupLink}`;
                        titleText = `<${formattedClickupLink}|${taskName}>`;
                    } else {
                        titleText = taskName;
                    }
                } else {
                    titleText = '[Task Name Required]';
                }
                
                // Create blocks array for proper Slack formatting
                const blocks = [];
                
                // Add checkmarks and title as header for final design
                if (selectedCommitType === 'final') {
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `:checklistiyang4::checklistiyang4::checklistiyang4::checklistiyang4::checklistiyang4:\n*${commitTypes[selectedCommitType]}:* ${titleText}`
                        }
                    });
                } else {
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `*${commitTypes[selectedCommitType]}:* ${titleText}`
                        }
                    });
                }
                
                // Add description if provided
                if (description) {
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: description
                        }
                    });
                }
                
                // Add Figma link with default text "Figma file"
                if (figmaLink) {
                    // Ensure proper URL format for Slack: <URL|DisplayText>
                    const formattedFigmaLink = figmaLink.startsWith('http') ? figmaLink : `https://${figmaLink}`;
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `üé® : <${formattedFigmaLink}|Figma file>`
                        }
                    });
                }
                
                // Add acknowledgments
                if (acknowledgedBy.length > 0) {
                    const ackUsers = acknowledgedBy.map(u => `<@${u}>`).join(' ');
                    let ackText = `This final design has been acknowledged by: ${ackUsers}`;

                    // Add CC if present
                    if (ccUsers.length > 0) {
                        const ccUsersText = ccUsers.map(u => `<@${u}>`).join(' ');
                        ackText += ` cc: ${ccUsersText}`;
                    }

                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: ackText
                        }
                    });
                }

                const payload = {
                    blocks: blocks
                };

                const endpoint = `${serverUrl}/api/send-to-slack`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        webhookUrl,
                        payload
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('‚úÖ Design commit sent successfully!', 'success');
                    clearForm();
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Send Design Commit';
            }
        }

        function clearForm() {
            document.getElementById('taskName').value = '';
            document.getElementById('clickupLink').value = '';
            document.getElementById('figmaLink').value = '';
            document.getElementById('descriptionEditor').textContent = '';
            acknowledgedBy = [];
            ccUsers = [];
            renderAcknowledgedByTags();
            renderCcTags();
            updatePreview();
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Periodic server check
        setInterval(checkServerStatus, 30000);
    </script>
</body>
</html>