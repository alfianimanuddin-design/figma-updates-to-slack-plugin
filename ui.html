<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Figma to Slack Notifier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
            line-height: 1.5;
            color: var(--figma-color-text, #1e1e1e);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-container {
            width: 100%;
        }

        .inline-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 11px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inline-warning a {
            color: #92400e;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

        .inline-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 11px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .required-indicator {
            color: #ef4444;
            font-weight: 600;
        }

        .field-valid {
            border-color: #10b981 !important;
            background: #f0fdf4;
        }

        .field-invalid {
            border-color: #ef4444 !important;
        }

        .field-feedback {
            font-size: 10px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-feedback.valid {
            color: #10b981;
        }

        .field-feedback.invalid {
            color: #ef4444;
        }

        .user-count-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #4f46e5;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-in {
            animation: slideIn 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .server-status {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 11px;
            text-align: center;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .server-status.online {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .server-status.offline {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .setup-section {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .setup-section h4 {
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--figma-color-text, #1e1e1e);
        }

        .form-section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--figma-color-bg, #ffffff);
            border-radius: 12px;
            /* border: 1px solid var(--figma-color-border, #e5e5e5); */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .form-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 12px;
            color: var(--figma-color-text, #1e1e1e);
        }

        .form-group .label-hint {
            font-size: 10px;
            color: var(--figma-color-text-secondary, #6b7280);
            font-weight: 400;
            margin-left: 4px;
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--figma-color-border, #efefef);
            border-radius: 10px;
            background: var(--figma-color-bg, #ffffff);
            color: var(--figma-color-text, #1e1e1e);
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-field:hover {
            border-color: var(--figma-color-text-secondary, #9ca3af);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .input-field::placeholder {
            color: var(--figma-color-text-tertiary, #9ca3af);
        }

        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        select.input-field:focus {
            cursor: pointer;
        }

        .textarea-field {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .rich-editor {
            border: 1.5px solid var(--figma-color-border, #efefef);
            border-radius: 10px;
            background: var(--figma-color-bg, #ffffff);
            min-height: 100px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rich-editor:hover {
            border-color: var(--figma-color-text-secondary, #9ca3af);
        }

        .rich-editor:focus-within {
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .editor-toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
            display: flex;
            gap: 4px;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            border-radius: 8px 8px 0 0;
        }

        .editor-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: var(--figma-color-text-secondary, #6b7280);
            transition: all 0.15s ease;
        }

        .editor-btn:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
            color: var(--figma-color-text, #1e1e1e);
        }

        .editor-btn.active {
            background: var(--figma-color-bg-brand, #3b82f6);
            color: white;
        }

        .editor-btn.list-btn {
            padding: 4px 6px;
        }

        .editor-btn svg {
            display: block;
            vertical-align: middle;
        }

        .toolbar-separator {
            color: var(--figma-color-border, #e5e5e5);
            margin: 0 4px;
            font-weight: 300;
        }

        .editor-content {
            padding: 12px;
            min-height: 80px;
            outline: none;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 0 0 8px 8px;
        }

        .editor-content:empty:before {
            content: attr(data-placeholder);
            color: var(--figma-color-text-tertiary, #9ca3af);
            pointer-events: none;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            border: 1.5px solid var(--figma-color-border, #efefef);
            border-radius: 10px;
            background: var(--figma-color-bg, #ffffff);
            color: var(--figma-color-text, #1e1e1e);
            font-size: 12px;
            font-family: inherit;
            min-height: 48px;
            align-items: center;
            width: 100%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: text;
        }

        .tags-input:hover {
            border-color: var(--figma-color-text-secondary, #9ca3af);
        }

        .tags-input:focus-within {
            border-color: var(--figma-color-border-brand, #3b82f6);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .tag {
            background: var(--figma-color-bg-brand, #3b82f6);
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .tag-input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
            color: var(--figma-color-text, #1e1e1e);
            flex: 1;
            min-width: 120px;
            padding: 0;
        }

        .tag-input::placeholder {
            color: var(--figma-color-text-tertiary, #9ca3af);
            font-size: 12px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.4);
        }

        .submit-btn:hover::before {
            opacity: 1;
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        }

        .submit-btn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .fixed-cta {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 20px 24px;
            z-index: 100;
            backdrop-filter: blur(8px);
            /* border-top: 1px solid var(--figma-color-border, #e5e5e5); */
        }

        .cta-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .status.loading {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            color: var(--figma-color-text, #1e1e1e);
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .preview-content {
            background: #36393f;
            color: #dcddde;
            padding: 18px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #40444b;
            min-height: 200px;
        }

        .preview-checkmarks {
            color: #00d26a;
            margin-bottom: 8px;
        }

        .preview-title {
            color: #b9bbbe;
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .preview-link {
            color: #00aff4;
            text-decoration: underline;
        }

        .preview-figma {
            color: #ff7262;
            margin: 12px 0;
        }

        .preview-ack {
            color: #dcddde;
            margin-top: 12px;
        }

        .preview-username {
            color: #00aff4;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--figma-color-bg, #ffffff);
            border: 1.5px solid var(--figma-color-border-brand, #3b82f6);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--figma-color-bg-hover, #f3f4f6);
        }

        .autocomplete-item-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--figma-color-text, #1e1e1e);
        }

        .autocomplete-item-username {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-top: 2px;
        }

        .autocomplete-item-role {
            font-size: 10px;
            color: var(--figma-color-text-tertiary, #9ca3af);
            margin-top: 2px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            /* padding-bottom: 20px;
            border-bottom: 2px solid var(--figma-color-border, #e5e5e5); */
        }

        .server-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: help;
            background: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
        }

        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #9ca3af;
            transition: all 0.3s ease;
        }

        .status-light.online {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }

        .status-light.offline {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        .status-tooltip {
            position: absolute;
            left: 44px;
            top: 3px;
            background: var(--figma-color-text, #1e1e1e);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .server-indicator:hover .status-tooltip {
            opacity: 1;
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--figma-color-text, #ffffff);
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .settings-btn {
            background: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            color: var(--figma-color-text-secondary, #6b7280);
            transition: all 0.2s ease;
            line-height: 1;
        }

        .settings-btn:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
            color: var(--figma-color-text, #1e1e1e);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: var(--figma-color-bg, #ffffff);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 92%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .settings-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--figma-color-text, #1e1e1e);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--figma-color-text-secondary, #6b7280);
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--figma-color-bg-hover, #f3f4f6);
            color: var(--figma-color-text, #1e1e1e);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--figma-color-text, #1e1e1e);
        }

        .settings-section p {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .fetch-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            margin-top: 12px;
        }

        .fetch-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .fetch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .user-count {
            font-size: 11px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            border-radius: 6px;
            text-align: center;
        }

        .user-count.success {
            background: #d1fae5;
            color: #065f46;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            color: #1e40af;
            margin-top: 12px;
            line-height: 1.5;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
        }

        .collapsible-section {
            border: 1px solid var(--figma-color-border, #e5e5e5);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background: var(--figma-color-bg-secondary, #f8f9fa);
            transition: background 0.2s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: var(--figma-color-bg-hover, #e5e7eb);
        }

        .collapsible-header h3 {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            color: var(--figma-color-text, #1e1e1e);
        }

        .collapsible-arrow {
            font-size: 12px;
            transition: transform 0.2s ease;
            color: var(--figma-color-text-secondary, #6b7280);
        }

        .collapsible-section.expanded .collapsible-arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: var(--figma-color-bg, #ffffff);
        }

        .collapsible-section.expanded .collapsible-content {
            max-height: 1000px;
        }

        .collapsible-inner {
            padding: 16px;
        }

        /* Confirmation Modal */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .confirmation-modal.show {
            display: flex;
        }

        .confirmation-content {
            background: var(--figma-color-bg, #ffffff);
            border-radius: 12px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideIn 0.3s ease;
        }

        .confirmation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 2px solid var(--figma-color-border, #e5e5e5);
            background: var(--figma-color-bg-secondary, #f8f9fa);
        }

        .confirmation-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--figma-color-text, #1e1e1e);
            margin: 0;
        }

        .confirmation-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .confirmation-subtitle {
            font-size: 12px;
            color: var(--figma-color-text-secondary, #6b7280);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .confirmation-preview {
            background: var(--figma-color-bg-secondary, #f8f9fa);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--figma-color-border, #e5e5e5);
        }

        .confirmation-footer {
            display: flex;
            gap: 12px;
            padding: 20px 24px;
            border-top: 2px solid var(--figma-color-border, #e5e5e5);
            background: var(--figma-color-bg-secondary, #f8f9fa);
        }

        .cancel-btn {
            flex: 1;
            background: var(--figma-color-bg, #ffffff);
            color: var(--figma-color-text, #1e1e1e);
            border: 1.5px solid var(--figma-color-border, #e5e5e5);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cancel-btn:hover {
            background: var(--figma-color-bg-hover, #f3f4f6);
            border-color: var(--figma-color-text-secondary, #6b7280);
        }

        .confirm-btn {
            flex: 2;
            background: linear-gradient(135deg, var(--figma-color-bg-brand, #3b82f6) 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Welcome Modal Styles */
        .welcome-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .welcome-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .welcome-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .welcome-content {
            color: white;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .welcome-body {
            margin-bottom: 28px;
        }

        .welcome-steps {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .welcome-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            color: white;
        }

        .welcome-step:last-child {
            margin-bottom: 0;
        }

        .welcome-step-number {
            background: white;
            color: #667eea;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .welcome-step-content {
            flex: 1;
        }

        .welcome-step-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .welcome-step-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.5;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .welcome-feature {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: white;
        }

        .welcome-feature-icon {
            font-size: 20px;
            margin-bottom: 4px;
            display: block;
        }

        .welcome-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .welcome-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .welcome-progress-dot.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }

        .welcome-actions {
            display: flex;
            gap: 12px;
        }

        .welcome-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .welcome-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .welcome-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .welcome-btn-primary {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .welcome-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .welcome-link {
            color: white;
            text-decoration: underline;
            cursor: pointer;
            opacity: 0.9;
        }

        .welcome-link:hover {
            opacity: 1;
        }

        .welcome-note {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.5;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Welcome Modal -->
    <div class="welcome-overlay" id="welcomeModal">
        <div class="welcome-modal">
            <div class="welcome-content">
                <!-- Step 1: Welcome -->
                <div class="welcome-step-content-wrapper" id="welcomeStep1">
                    <div class="welcome-header">
                        <span class="welcome-icon">üé®</span>
                        <h2 class="welcome-title">Welcome to Figma Updates!</h2>
                        <p class="welcome-subtitle">Share design updates to Slack with beautiful, Git-style commit messages.</p>
                    </div>

                    <div class="welcome-body">
                        <div class="welcome-features">
                            <div class="welcome-feature">
                                <span class="welcome-feature-icon">‚ú®</span>
                                <strong>Git-Style Commits</strong><br>
                                5 commit types
                            </div>
                            <div class="welcome-feature">
                                <span class="welcome-feature-icon">üë•</span>
                                <strong>@Mentions</strong><br>
                                Tag teammates
                            </div>
                            <div class="welcome-feature">
                                <span class="welcome-feature-icon">üìù</span>
                                <strong>Rich Text</strong><br>
                                Formatted descriptions
                            </div>
                            <div class="welcome-feature">
                                <span class="welcome-feature-icon">‚ö°</span>
                                <strong>One-Click</strong><br>
                                Instant posting
                            </div>
                        </div>
                    </div>

                    <div class="welcome-progress">
                        <div class="welcome-progress-dot active"></div>
                        <div class="welcome-progress-dot"></div>
                        <div class="welcome-progress-dot"></div>
                    </div>

                    <div class="welcome-actions">
                        <button class="welcome-btn welcome-btn-secondary" onclick="skipWelcome()">Skip Tour</button>
                        <button class="welcome-btn welcome-btn-primary" onclick="nextWelcomeStep()">Next ‚Üí</button>
                    </div>
                </div>

                <!-- Step 2: Setup -->
                <div class="welcome-step-content-wrapper" id="welcomeStep2" style="display: none;">
                    <div class="welcome-header">
                        <span class="welcome-icon">üîë</span>
                        <h2 class="welcome-title">Quick Setup Required</h2>
                        <p class="welcome-subtitle">One-time configuration to connect your Slack workspace.</p>
                    </div>

                    <div class="welcome-body">
                        <div class="welcome-steps">
                            <div class="welcome-step">
                                <div class="welcome-step-number">1</div>
                                <div class="welcome-step-content">
                                    <div class="welcome-step-title">Create Slack App</div>
                                    <div class="welcome-step-desc">Get your Bot Token from api.slack.com/apps</div>
                                </div>
                            </div>
                            <div class="welcome-step">
                                <div class="welcome-step-number">2</div>
                                <div class="welcome-step-content">
                                    <div class="welcome-step-title">Configure in Settings</div>
                                    <div class="welcome-step-desc">Add token, fetch users & channels</div>
                                </div>
                            </div>
                            <div class="welcome-step">
                                <div class="welcome-step-number">3</div>
                                <div class="welcome-step-content">
                                    <div class="welcome-step-title">Start Committing!</div>
                                    <div class="welcome-step-desc">Share updates with your team</div>
                                </div>
                            </div>
                        </div>

                        <div class="welcome-note">
                            üí° <strong>Need help?</strong> Check out our <a class="welcome-link" href="https://github.com/alfianimanuddin-design/figma-updates-to-slack-plugin/blob/master/SETUP_GUIDE.md" target="_blank">complete setup guide</a>
                        </div>
                    </div>

                    <div class="welcome-progress">
                        <div class="welcome-progress-dot"></div>
                        <div class="welcome-progress-dot active"></div>
                        <div class="welcome-progress-dot"></div>
                    </div>

                    <div class="welcome-actions">
                        <button class="welcome-btn welcome-btn-secondary" onclick="previousWelcomeStep()">‚Üê Back</button>
                        <button class="welcome-btn welcome-btn-primary" onclick="nextWelcomeStep()">Next ‚Üí</button>
                    </div>
                </div>

                <!-- Step 3: Ready -->
                <div class="welcome-step-content-wrapper" id="welcomeStep3" style="display: none;">
                    <div class="welcome-header">
                        <span class="welcome-icon">üöÄ</span>
                        <h2 class="welcome-title">You're All Set!</h2>
                        <p class="welcome-subtitle">Ready to share your first design update?</p>
                    </div>

                    <div class="welcome-body">
                        <div class="welcome-note">
                            <strong>Next steps:</strong><br>
                            1. Click the <strong>‚öôÔ∏è Settings</strong> button (top right)<br>
                            2. Add your Slack Bot Token<br>
                            3. Fetch users and configure channels<br>
                            4. Make your first commit!
                        </div>

                        <div class="welcome-steps">
                            <div class="welcome-step">
                                <div class="welcome-step-number">üìñ</div>
                                <div class="welcome-step-content">
                                    <div class="welcome-step-title">Setup Guide</div>
                                    <div class="welcome-step-desc">
                                        <a class="welcome-link" href="https://github.com/alfianimanuddin-design/figma-updates-to-slack-plugin/blob/master/SETUP_GUIDE.md" target="_blank">Complete instructions</a>
                                    </div>
                                </div>
                            </div>
                            <div class="welcome-step">
                                <div class="welcome-step-number">üí¨</div>
                                <div class="welcome-step-content">
                                    <div class="welcome-step-title">Need Help?</div>
                                    <div class="welcome-step-desc">
                                        <a class="welcome-link" href="https://github.com/alfianimanuddin-design/figma-updates-to-slack-plugin/issues" target="_blank">Report issues on GitHub</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="welcome-progress">
                        <div class="welcome-progress-dot"></div>
                        <div class="welcome-progress-dot"></div>
                        <div class="welcome-progress-dot active"></div>
                    </div>

                    <div class="welcome-actions">
                        <button class="welcome-btn welcome-btn-secondary" onclick="previousWelcomeStep()">‚Üê Back</button>
                        <button class="welcome-btn welcome-btn-primary" onclick="closeWelcome()">Let's Go! üéâ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <!-- Header Controls -->
            <div class="header-controls">
                <div class="server-indicator">
                    <div class="status-light" id="statusLight"></div>
                    <div class="status-tooltip" id="statusTooltip">Checking...</div>
                </div>
                <h1 class="page-title">
                    <!-- <span>üé®</span> -->
                    Figma to Slack Notifier
                </h1>
                <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
            </div>

            <!-- Channel Selection Card -->
            <div class="form-section">
                <!-- Slack Channels Warning -->
                <div id="slackChannelsWarning" class="inline-warning" style="display: none;">
                    ‚ö†Ô∏è No Slack channels configured. <a onclick="openSettings()">Configure channels in Settings</a> to send commits.
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="slackChannel">
                        Slack Channel <span class="required-indicator">*</span>
                    </label>
                    <select id="slackChannel" class="input-field">
                        <option value="">Select a channel...</option>
                    </select>
                    <div id="slackChannelFeedback" class="field-feedback"></div>
                </div>
            </div>

            <!-- Project Details Card -->
            <div class="form-section" style="margin-bottom: 36px;">
                <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 20px; color: var(--figma-color-text, #1e1e1e);">Project Details</h3>

                <div class="form-group">
                    <label for="taskName">
                        Task Name <span class="required-indicator">*</span>
                    </label>
                    <input type="text" id="taskName" class="input-field"
                           placeholder="e.g., Payment Page Revamp" required>
                    <div id="taskNameFeedback" class="field-feedback"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="clickupLink">
                            ClickUp Task Link <span class="required-indicator">*</span>
                        </label>
                        <input type="url" id="clickupLink" class="input-field"
                               placeholder="https://app.clickup.com/t/..." required>
                        <div id="clickupLinkFeedback" class="field-feedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="figmaLink">
                            Figma Project Link <span class="required-indicator">*</span>
                        </label>
                        <input type="url" id="figmaLink" class="input-field"
                               placeholder="https://www.figma.com/file/..." required>
                        <div id="figmaLinkFeedback" class="field-feedback"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description <span class="required-indicator">*</span></label>
                    <div class="rich-editor">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" data-command="bold" title="Bold">
                                <strong>B</strong>
                            </button>
                            <button type="button" class="editor-btn" data-command="italic" title="Italic">
                                <em>I</em>
                            </button>
                            <button type="button" class="editor-btn" data-command="underline" title="Underline">
                                <u>U</u>
                            </button>
                            <button type="button" class="editor-btn" data-command="strikeThrough" title="Strikethrough">
                                <s>S</s>
                            </button>
                            <span class="toolbar-separator">|</span>
                            <button type="button" class="editor-btn list-btn" data-command="insertOrderedList" title="Numbered List">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <text x="1" y="5" font-size="6" fill="currentColor">1.</text>
                                    <line x1="5" y1="4" x2="14" y2="4" stroke="currentColor" stroke-width="1"/>
                                    <text x="1" y="10" font-size="6" fill="currentColor">2.</text>
                                    <line x1="5" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1"/>
                                    <text x="1" y="15" font-size="6" fill="currentColor">3.</text>
                                    <line x1="5" y1="14" x2="14" y2="14" stroke="currentColor" stroke-width="1"/>
                                </svg>
                            </button>
                            <button type="button" class="editor-btn list-btn" data-command="insertUnorderedList" title="Bullet List">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="2.5" cy="3.5" r="1.5" fill="currentColor"/>
                                    <line x1="5" y1="4" x2="14" y2="4" stroke="currentColor" stroke-width="1"/>
                                    <circle cx="2.5" cy="8.5" r="1.5" fill="currentColor"/>
                                    <line x1="5" y1="9" x2="14" y2="9" stroke="currentColor" stroke-width="1"/>
                                    <circle cx="2.5" cy="13.5" r="1.5" fill="currentColor"/>
                                    <line x1="5" y1="14" x2="14" y2="14" stroke="currentColor" stroke-width="1"/>
                                </svg>
                            </button>
                        </div>
                        <div id="descriptionEditor" class="editor-content" contenteditable="true"
                             data-placeholder="Add details about what's been completed in this design..."></div>
                    </div>
                </div>

                <!-- Slack Users Warning -->
                <div id="slackUsersWarning" class="inline-warning" style="display: none;">
                    ‚ö†Ô∏è No Slack users loaded. <a onclick="openSettings()">Fetch users in Settings</a> for autocomplete.
                </div>

                <div class="form-group">
                    <label for="acknowledgedByInput">
                        Acknowledged by <span class="required-indicator">*</span>
                    </label>
                    <div class="autocomplete-container">
                        <div class="tags-input" id="acknowledgedByTags">
                            <input type="text" id="acknowledgedByInput" class="tag-input"
                                   placeholder="Type name or username..." autocomplete="off">
                        </div>
                        <div class="autocomplete-dropdown" id="acknowledgedByDropdown"></div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="ccInput">CC <span class="label-hint">(optional)</span></label>
                    <div class="autocomplete-container">
                        <div class="tags-input" id="ccTags">
                            <input type="text" id="ccInput" class="tag-input"
                                   placeholder="Type name or username..." autocomplete="off">
                        </div>
                        <div class="autocomplete-dropdown" id="ccDropdown"></div>
                    </div>
                </div>
            </div>

        <!-- Spacing for fixed CTA -->
        <div style="height: 80px;"></div>

        <div id="status" class="status"></div>

        <!-- Hidden preview content for confirmation modal -->
        <div id="previewContent" style="display: none;"></div>
        </div>

        <!-- Fixed CTA at bottom -->
        <div class="fixed-cta">
            <div class="cta-container">
                <button type="button" class="submit-btn" id="submitBtn" onclick="commitToSlack()" disabled title="Keyboard shortcut: Cmd/Ctrl + Enter">
                    Share Final Design to Slack
                </button>
                <p style="text-align: center; font-size: 10px; color: var(--figma-color-text-secondary, #6b7280); margin-top: 8px; margin-bottom: 0;">
                    üí° Tip: Press <kbd style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Cmd/Ctrl + Enter</kbd> to send
                </p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>üîë Slack Bot Token</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 12px; line-height: 1.5;">
                            Configure your Slack Bot Token to enable fetching users and channels from your workspace.
                        </p>

                        <div class="form-group">
                            <label for="slackToken">Slack Bot Token</label>
                            <div style="position: relative;">
                                <input type="password" id="slackToken" class="input-field"
                                       placeholder="xoxb-your-bot-token-here"
                                       style="padding-right: 40px;">
                                <button type="button"
                                        id="toggleSlackToken"
                                        onclick="togglePasswordVisibility('slackToken')"
                                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px 8px; font-size: 16px; color: var(--figma-color-text-secondary, #6b7280); display: flex; align-items: center; justify-content: center;">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </div>

                        <button class="fetch-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="saveSlackToken()">
                            üíæ Save Token
                        </button>

                        <div id="tokenSaveStatus" class="user-count" style="display: none;"></div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--figma-color-border, #e5e5e5);">
                            <p id="tokenStatus" style="font-size: 11px; margin: 0; color: #6b7280;">No token saved yet.</p>
                        </div>

                        <div class="info-box">
                            <strong>How to get your Slack Bot Token:</strong>
                            1. Go to <a href="https://api.slack.com/apps" target="_blank">api.slack.com/apps</a><br>
                            2. Select your app or create a new one<br>
                            3. Go to "OAuth & Permissions"<br>
                            4. Add scopes: <code>users:read</code>, <code>users:read.email</code>, <code>channels:read</code>, <code>groups:read</code><br>
                            5. Install app to your workspace<br>
                            6. Copy the "Bot User OAuth Token"
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>üë• Fetch Slack Users</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 12px; line-height: 1.5;">
                            Fetch all users from your workspace to enable autocomplete for acknowledgments.
                        </p>

                        <button class="fetch-btn" id="fetchUsersBtn" onclick="fetchSlackUsers()">
                            üîÑ Fetch Users from Slack
                        </button>

                        <div id="userCount" class="user-count" style="display: none;"></div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--figma-color-border, #e5e5e5);">
                            <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--figma-color-text, #1e1e1e);">Current Status</h4>
                            <p id="currentUsersCount" style="font-size: 11px; margin: 0;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>üì∫ Configure Channels</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 8px; line-height: 1.5;">
                            Fetch channels where your bot is a member and configure webhook URLs for posting updates.
                        </p>

                        <div class="info-box" style="margin-bottom: 12px; font-size: 10px;">
                            <strong>üí° Important:</strong> Only channels where you've invited your bot will appear.
                            To add the bot to a channel: In Slack, go to the channel ‚Üí Click channel name ‚Üí Integrations ‚Üí Add apps ‚Üí Select your bot.
                        </div>

                        <button class="fetch-btn" id="fetchChannelsBtn" onclick="fetchSlackChannels()">
                            üîÑ Fetch Channels from Slack
                        </button>

                        <div id="channelsFetchStatus" class="user-count" style="display: none;"></div>

                        <div id="channelsConfig" style="margin-top: 16px; display: none;">
                            <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: var(--figma-color-text, #1e1e1e);">Configure Webhook URLs</h4>
                            <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 12px;">
                                For each channel you want to use, you need to create an Incoming Webhook.
                                <a href="https://api.slack.com/messaging/webhooks" target="_blank" style="color: #3b82f6;">Learn how</a>
                            </p>
                            <div id="channelsList"></div>

                            <button class="fetch-btn" style="margin-top: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="saveChannelConfig()">
                                üíæ Save Channel Configuration
                            </button>
                        </div>

                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--figma-color-border, #e5e5e5);">
                            <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--figma-color-text, #1e1e1e);">Configured Channels</h4>
                            <p id="currentChannelsCount" style="font-size: 11px; margin: 0;">No channels configured yet.</p>
                        </div>

                        <div class="info-box" style="margin-top: 12px;">
                            <strong>How to create a webhook for a channel:</strong>
                            1. Go to <a href="https://api.slack.com/apps" target="_blank">api.slack.com/apps</a><br>
                            2. Select your app ‚Üí "Incoming Webhooks"<br>
                            3. Toggle "Activate Incoming Webhooks" ON<br>
                            4. Click "Add New Webhook to Workspace"<br>
                            5. Select the channel<br>
                            6. Copy the webhook URL and paste it here
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clear All Data Section -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3 style="color: #dc2626;">üóëÔ∏è Clear All Data</h3>
                    <span class="collapsible-arrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="font-size: 11px; color: #dc2626; margin-bottom: 12px; line-height: 1.5; font-weight: 600;">
                            ‚ö†Ô∏è Warning: This will delete all saved data including:
                        </p>
                        <ul style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 16px; padding-left: 20px; line-height: 1.6;">
                            <li>Slack Bot Token</li>
                            <li>Fetched Slack Users</li>
                            <li>Channel Configurations</li>
                            <li>Saved Acknowledgments</li>
                            <li>All Settings</li>
                        </ul>
                        <p style="font-size: 11px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 16px;">
                            This action cannot be undone. You'll need to reconfigure everything from scratch.
                        </p>
                        <button class="fetch-btn" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);" onclick="clearAllData()">
                            üóëÔ∏è Clear All Data
                        </button>
                        <div id="clearDataStatus" class="user-count" style="margin-top: 12px; display: none;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Welcome Onboarding Modal -->
    <div class="settings-modal" id="welcomeModal">
        <div class="settings-content" style="max-width: 460px; max-height: 620px; padding: 0;">
            <!-- Compact Header with Gradient -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 24px; text-align: center; border-radius: 12px 12px 0 0;">
                <div style="font-size: 48px; margin-bottom: 8px;">üëã</div>
                <h2 style="font-size: 20px; font-weight: 700; color: white; margin: 0 0 8px 0;">Welcome to Figma to Slack Notifier!</h2>
                <p style="font-size: 12px; color: rgba(255,255,255,0.9); margin: 0;">Share your Figma designs to Slack with style</p>
            </div>

            <!-- Compact Body -->
            <div style="padding: 20px 24px 24px 24px;">
                <p style="font-size: 12px; color: var(--figma-color-text-secondary, #6b7280); margin-bottom: 16px; text-align: center; line-height: 1.5;">
                    Quick setup to get started:
                </p>

                <!-- Compact Steps -->
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px;">
                    <!-- Step 1 -->
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 20px; flex-shrink: 0;">üë•</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--figma-color-text, #1e1e1e); margin-bottom: 2px;">Fetch Slack Users</div>
                            <div style="font-size: 10px; color: var(--figma-color-text-secondary, #6b7280); line-height: 1.4;">Enable autocomplete for team member acknowledgments</div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #f59e0b;">
                        <div style="font-size: 20px; flex-shrink: 0;">üì¢</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--figma-color-text, #1e1e1e); margin-bottom: 2px;">Configure Channels</div>
                            <div style="font-size: 10px; color: var(--figma-color-text-secondary, #6b7280); line-height: 1.4;">Connect channels to post your design notifications</div>
                        </div>
                    </div>
                </div>

                <!-- Info Box -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 10px 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #fbbf24;">
                    <p style="font-size: 10px; color: #92400e; line-height: 1.5; margin: 0;">
                        <strong>üí° Note:</strong> You can skip this now and configure later via Settings ‚öôÔ∏è
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeWelcome()" style="flex: 1; padding: 10px 16px; border: 1.5px solid #e5e7eb; background: white; border-radius: 6px; font-size: 12px; font-weight: 500; color: var(--figma-color-text-secondary, #6b7280); cursor: pointer; transition: all 0.2s;">
                        Skip for Now
                    </button>
                    <button onclick="startSetup()" style="flex: 1; padding: 10px 16px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 6px; font-size: 12px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;">
                        üöÄ Get Started
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <h2>üì§ Confirm Send to Slack</h2>
                <button class="close-btn" onclick="closeConfirmation()">&times;</button>
            </div>

            <div class="confirmation-body">
                <p class="confirmation-subtitle">Please review your message before sending:</p>
                <div class="confirmation-preview">
                    <div id="confirmationPreviewContent" class="preview-content">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="confirmation-footer">
                <button class="cancel-btn" onclick="closeConfirmation()">Cancel</button>
                <button class="confirm-btn" onclick="confirmSend()">‚úì Confirm & Send to Slack</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        // IMPORTANT: This should be the production server URL for all users
        // Only change this to 'http://localhost:3000' during local development
        const SERVER_URL = 'https://figma-slack-bridge.vercel.app';
        const selectedCommitType = 'final'; // Hardcoded to final design

        // State variables
        let serverOnline = false;
        let acknowledgedBy = [];
        let ccUsers = [];
        let slackUsers = [];
        let slackChannels = [];
        let channelConfigs = {}; // Store channel webhook mappings
        let currentFocusIndex = -1;
        let currentDropdownType = null; // 'acknowledged' or 'cc'
        let isFirstTime = false;

        // Initialize
        window.onload = async function() {
            await loadSlackToken();
            await loadSlackUsers();
            await loadChannelConfigs();
            setupEventListeners();
            checkServerStatus();
            updatePreview();
            updateCurrentUsersCount();
            updateCurrentChannelsCount();
            validateForm(); // Initial form validation
            loadSavedAcknowledgments();

            // Check for first time use after everything is loaded
            // Add a small delay to ensure DOM is fully ready
            setTimeout(() => {
                checkFirstTimeUse();
            }, 100);
        };

        // Check if this is first time use
        function checkFirstTimeUse() {
            let hasSeenWelcome = false;

            try {
                hasSeenWelcome = localStorage.getItem('hasSeenWelcome') === 'true';
            } catch (e) {
                console.log('LocalStorage not available for welcome check, defaulting to false');
                hasSeenWelcome = false;
            }

            const hasSlackUsers = slackUsers.length > 0;
            const hasChannels = Object.keys(channelConfigs).length > 0;

            console.log('Onboarding check:', {
                hasSeenWelcome,
                hasSlackUsers,
                hasChannels,
                usersCount: slackUsers.length,
                channelsCount: Object.keys(channelConfigs).length
            });

            // Show welcome modal if user hasn't seen it and has no data
            if (!hasSeenWelcome && !hasSlackUsers && !hasChannels) {
                isFirstTime = true;
                console.log('Showing welcome modal...');

                // Hide warnings during onboarding
                const usersWarning = document.getElementById('slackUsersWarning');
                const channelsWarning = document.getElementById('slackChannelsWarning');
                if (usersWarning) usersWarning.style.display = 'none';
                if (channelsWarning) channelsWarning.style.display = 'none';

                // Show welcome modal after a short delay
                setTimeout(() => {
                    const modal = document.getElementById('welcomeModal');
                    if (modal) {
                        modal.classList.add('show');
                        console.log('Welcome modal shown successfully');
                    } else {
                        console.error('Welcome modal element not found in DOM!');
                    }
                }, 500);
            } else {
                console.log('Welcome modal not shown - conditions not met');
            }
        }

        // Welcome Modal Functions
        function closeWelcome() {
            document.getElementById('welcomeModal').classList.remove('show');
            isFirstTime = false;

            // Mark as seen
            try {
                localStorage.setItem('hasSeenWelcome', 'true');
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Show warnings if still no data
            updateCurrentUsersCount();
            updateCurrentChannelsCount();
        }

        function startSetup() {
            document.getElementById('welcomeModal').classList.remove('show');
            isFirstTime = false;

            // Mark as seen
            try {
                localStorage.setItem('hasSeenWelcome', 'true');
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Open settings with sections expanded
            openSettings();
            setTimeout(() => {
                // Expand both Fetch Users and Configure Channels sections
                const sections = document.querySelectorAll('.collapsible-section');
                sections.forEach((section, index) => {
                    // Expand first two sections (Fetch Users and Configure Channels)
                    if (index < 2) {
                        section.classList.add('expanded');
                    }
                });
            }, 100);
        }

        // Validate URL format
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Validate ClickUp URL
        function isValidClickUpUrl(url) {
            return isValidUrl(url) && (url.includes('clickup.com') || url.includes('app.clickup.com'));
        }

        // Validate Figma URL
        function isValidFigmaUrl(url) {
            return isValidUrl(url) && url.includes('figma.com');
        }

        // Show field feedback
        function showFieldFeedback(fieldId, feedbackId, message, isValid) {
            const field = document.getElementById(fieldId);
            const feedback = document.getElementById(feedbackId);

            field.classList.remove('field-valid', 'field-invalid');
            feedback.classList.remove('valid', 'invalid');

            if (message) {
                if (isValid) {
                    field.classList.add('field-valid');
                    feedback.classList.add('valid');
                    feedback.innerHTML = `‚úì ${message}`;
                } else {
                    field.classList.add('field-invalid');
                    feedback.classList.add('invalid');
                    feedback.innerHTML = `‚úó ${message}`;
                }
            } else {
                feedback.innerHTML = '';
            }
        }

        // Validate form and enable/disable submit button
        function validateForm() {
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();
            const description = document.getElementById('descriptionEditor').textContent.trim();
            const slackChannel = document.getElementById('slackChannel').value.trim();

            const isValid = taskName &&
                          isValidClickUpUrl(clickupLink) &&
                          isValidFigmaUrl(figmaLink) &&
                          description &&
                          acknowledgedBy.length > 0 &&
                          slackChannel;

            document.getElementById('submitBtn').disabled = !isValid;
            return isValid;
        }

        // Load saved acknowledgments
        function loadSavedAcknowledgments() {
            try {
                const saved = localStorage.getItem('lastAcknowledgments');
                if (saved) {
                    // We don't auto-fill, just keep it available
                    console.log('Last used acknowledgments available');
                }
            } catch (e) {
                console.log('LocalStorage not available');
            }
        }

        // Save acknowledgments for next time
        function saveAcknowledgments() {
            try {
                if (acknowledgedBy.length > 0) {
                    localStorage.setItem('lastAcknowledgments', JSON.stringify(acknowledgedBy));
                }
            } catch (e) {
                console.log('LocalStorage not available');
            }
        }

        // Load Slack users from Figma storage
        async function loadSlackUsers() {
            try {
                parent.postMessage({ pluginMessage: { type: 'load-slack-users' } }, '*');
            } catch (storageError) {
                console.error('Error loading from Figma storage:', storageError);
                slackUsers = [];
                updateCurrentUsersCount();
            }
        }

        // Listen for messages from plugin code
        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'load-slack-users-success') {
                if (msg.data && msg.data.users) {
                    slackUsers = msg.data.users;
                    console.log('Loaded', slackUsers.length, 'Slack users from Figma storage');
                } else {
                    slackUsers = [];
                }
                updateCurrentUsersCount();
            } else if (msg.type === 'load-slack-users-error') {
                console.error('Error loading from Figma storage:', msg.error);
                slackUsers = [];
                updateCurrentUsersCount();
            } else if (msg.type === 'save-slack-users-success') {
                console.log('Successfully saved Slack users to Figma storage');
            } else if (msg.type === 'save-slack-users-error') {
                console.error('Error saving to Figma storage:', msg.error);
            } else if (msg.type === 'load-channel-configs-success') {
                if (msg.data) {
                    channelConfigs = msg.data;
                    console.log('Loaded channel configs from Figma storage');
                    updateChannelDropdown();
                    updateCurrentChannelsCount();
                }
            } else if (msg.type === 'load-channel-configs-error') {
                console.error('Error loading channel configs:', msg.error);
            } else if (msg.type === 'save-channel-configs-success') {
                console.log('Successfully saved channel configs to Figma storage');
            } else if (msg.type === 'save-channel-configs-error') {
                console.error('Error saving channel configs:', msg.error);
            } else if (msg.type === 'load-slack-token-success') {
                if (msg.data) {
                    const tokenInput = document.getElementById('slackToken');
                    const tokenStatusEl = document.getElementById('tokenStatus');

                    if (tokenInput) {
                        tokenInput.value = msg.data;
                    }

                    if (tokenStatusEl) {
                        tokenStatusEl.textContent = '‚úÖ Token configured';
                        tokenStatusEl.style.color = '#065f46';
                    }
                }
            } else if (msg.type === 'load-slack-token-error') {
                console.error('Error loading token:', msg.error);
            } else if (msg.type === 'save-slack-token-success') {
                console.log('Successfully saved Slack token to Figma storage');
            } else if (msg.type === 'save-slack-token-error') {
                console.error('Error saving token:', msg.error);
            }
        };

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function toggleCollapsible(header) {
            const section = header.parentElement;
            section.classList.toggle('expanded');
        }

        // Clear All Data
        async function clearAllData() {
            const confirmed = confirm(
                '‚ö†Ô∏è WARNING: This will permanently delete ALL saved data!\n\n' +
                'This includes:\n' +
                '‚Ä¢ Slack Bot Token\n' +
                '‚Ä¢ All Fetched Users\n' +
                '‚Ä¢ Channel Configurations\n' +
                '‚Ä¢ Saved Acknowledgments\n\n' +
                'You will need to reconfigure everything from scratch.\n\n' +
                'Are you absolutely sure you want to continue?'
            );

            if (!confirmed) {
                return;
            }

            const statusEl = document.getElementById('clearDataStatus');
            statusEl.textContent = 'üîÑ Clearing all data...';
            statusEl.style.display = 'block';
            statusEl.className = 'user-count';

            try {
                // Clear localStorage (if available)
                try {
                    localStorage.clear();
                    console.log('localStorage cleared');
                } catch (e) {
                    console.log('localStorage not available, skipping');
                }

                // Clear Figma clientStorage
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-slack-users',
                        data: null
                    }
                }, '*');

                parent.postMessage({
                    pluginMessage: {
                        type: 'save-channel-configs',
                        data: null
                    }
                }, '*');

                parent.postMessage({
                    pluginMessage: {
                        type: 'save-slack-token',
                        data: null
                    }
                }, '*');

                // Reset all state variables
                slackUsers = [];
                slackChannels = [];
                channelConfigs = {};
                acknowledgedBy = [];
                ccUsers = [];

                // Clear form fields
                document.getElementById('slackToken').value = '';
                document.getElementById('taskName').value = '';
                document.getElementById('clickupLink').value = '';
                document.getElementById('figmaLink').value = '';
                document.getElementById('descriptionEditor').textContent = '';
                document.getElementById('slackChannel').value = '';

                // Update UI
                updateCurrentUsersCount();
                updateCurrentChannelsCount();
                updateChannelDropdown();
                renderAcknowledgedByTags();
                renderCcTags();
                validateForm();

                // Clear token status
                const tokenStatusEl = document.getElementById('tokenStatus');
                if (tokenStatusEl) {
                    tokenStatusEl.style.display = 'none';
                }

                // Show success message
                statusEl.textContent = '‚úÖ All data cleared successfully! Plugin reset to fresh state.';
                statusEl.className = 'user-count success';
                statusEl.style.color = '#065f46';

                // Close settings and show welcome modal after clearing
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    closeSettings();

                    // Show welcome modal after a delay
                    setTimeout(() => {
                        checkFirstTimeUse();
                    }, 500);
                }, 2000);

            } catch (error) {
                console.error('Error clearing data:', error);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
                statusEl.className = 'user-count error';
                statusEl.style.color = '#dc2626';
            }
        }

        // Toggle Password Visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const toggleBtn = document.getElementById('toggleSlackToken');

            if (!input || !toggleBtn) return;

            if (input.type === 'password') {
                input.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }

        // Slack Token Management
        async function saveSlackToken() {
            const tokenInput = document.getElementById('slackToken');
            const statusEl = document.getElementById('tokenSaveStatus');
            const tokenStatusEl = document.getElementById('tokenStatus');

            if (!tokenInput || !statusEl || !tokenStatusEl) {
                console.error('Token elements not found');
                return;
            }

            const token = tokenInput.value.trim();

            if (!token) {
                statusEl.textContent = '‚ö†Ô∏è Please enter a token';
                statusEl.className = 'user-count';
                statusEl.style.display = 'block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                return;
            }

            if (!token.startsWith('xoxb-')) {
                statusEl.textContent = '‚ö†Ô∏è Token should start with "xoxb-"';
                statusEl.className = 'user-count';
                statusEl.style.display = 'block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                return;
            }

            // Save to localStorage
            try {
                localStorage.setItem('slackBotToken', token);
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Save to Figma storage
            parent.postMessage({
                pluginMessage: {
                    type: 'save-slack-token',
                    data: token
                }
            }, '*');

            // Show success
            statusEl.textContent = '‚úÖ Token saved successfully!';
            statusEl.className = 'user-count success';
            statusEl.style.display = 'block';

            // Update status text
            tokenStatusEl.textContent = '‚úÖ Token configured';
            tokenStatusEl.style.color = '#065f46';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        async function loadSlackToken() {
            try {
                // Try localStorage first
                const saved = localStorage.getItem('slackBotToken');
                if (saved) {
                    const tokenInput = document.getElementById('slackToken');
                    const tokenStatusEl = document.getElementById('tokenStatus');

                    if (tokenInput) {
                        tokenInput.value = saved;
                    }

                    if (tokenStatusEl) {
                        tokenStatusEl.textContent = '‚úÖ Token configured';
                        tokenStatusEl.style.color = '#065f46';
                    }
                    return;
                }
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Try Figma storage
            parent.postMessage({ pluginMessage: { type: 'load-slack-token' } }, '*');
        }

        function updateCurrentUsersCount() {
            const countEl = document.getElementById('currentUsersCount');
            const warning = document.getElementById('slackUsersWarning');

            // Null check - some elements might not exist
            if (!countEl) {
                console.log('currentUsersCount element not found');
                return;
            }

            if (slackUsers.length > 0) {
                countEl.textContent = `Currently loaded: ${slackUsers.length} users`;
                countEl.style.color = '#065f46';

                // Hide warning
                if (warning) warning.style.display = 'none';
            } else {
                countEl.textContent = 'No users loaded. Please fetch users from Slack.';
                countEl.style.color = '#dc2626';

                // Show warning
                if (warning) warning.style.display = 'flex';
            }
        }

        // Fetch Slack Users
        async function fetchSlackUsers() {
            const tokenInput = document.getElementById('slackToken');
            const fetchBtn = document.getElementById('fetchUsersBtn');
            const userCountEl = document.getElementById('userCount');

            // Null checks for all elements
            if (!tokenInput || !userCountEl) {
                console.error('Required elements not found in DOM');
                alert('UI Error: Please reload the plugin');
                return;
            }

            const token = tokenInput.value.trim();

            if (!token) {
                userCountEl.textContent = '‚ö†Ô∏è Please enter your Slack Bot Token in the first section';
                userCountEl.style.display = 'block';
                userCountEl.className = 'user-count';
                return;
            }

            if (!token.startsWith('xoxb-')) {
                userCountEl.textContent = '‚ö†Ô∏è Token should start with "xoxb-"';
                userCountEl.style.display = 'block';
                userCountEl.className = 'user-count';
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ Fetching users...';
            userCountEl.style.display = 'block';
            userCountEl.textContent = 'Connecting to Slack via proxy...';
            userCountEl.className = 'user-count';

            try {
                // Call Vercel proxy endpoint instead of Slack API directly
                const response = await fetch(`${SERVER_URL}/api/fetch-slack-users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const result = await response.json();

                if (!result.success) {
                    const errorMsg = result.details ? `${result.error}: ${result.details}` : (result.error || 'Failed to fetch users');
                    console.error('Slack API error details:', result);
                    throw new Error(errorMsg);
                }

                const userData = result.data;
                const users = userData.users;

                if (!users || users.length === 0) {
                    throw new Error('No users found');
                }

                // Save to Figma storage
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-slack-users',
                        data: userData
                    }
                }, '*');

                // Update the current users list
                slackUsers = users;

                userCountEl.textContent = `‚úÖ Successfully fetched ${users.length} users!`;
                userCountEl.className = 'user-count success';

                updateCurrentUsersCount();

                // Show success message
                setTimeout(() => {
                    userCountEl.textContent = `Users have been saved. You can now use autocomplete with ${users.length} team members.`;
                }, 2000);

            } catch (error) {
                console.error('Error fetching users:', error);
                userCountEl.textContent = `‚ùå Error: ${error.message}`;
                userCountEl.className = 'user-count';

                // Check for specific Slack error codes in the message
                if (error.message.includes('ratelimited')) {
                    userCountEl.textContent = '‚è±Ô∏è Rate Limited: Slack API temporarily blocked your requests.\nüí° Please wait 1-2 minutes and try again.';
                } else if (error.message.includes('invalid_auth') || error.message.includes('not_authed')) {
                    userCountEl.textContent += '\nüí° Your token is invalid. Please reinstall your Slack app and get a new token.';
                } else if (error.message.includes('missing_scope')) {
                    userCountEl.textContent += '\nüí° Add these scopes: users:read, users:read.email, then reinstall your app.';
                } else if (error.message.includes('token_revoked')) {
                    userCountEl.textContent += '\nüí° Your token was revoked. Please reinstall your Slack app and get a new token.';
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîÑ Fetch Users from Slack';
            }
        }

        // Fetch Slack Channels
        async function fetchSlackChannels() {
            const tokenInput = document.getElementById('slackToken');
            const fetchBtn = document.getElementById('fetchChannelsBtn');
            const statusEl = document.getElementById('channelsFetchStatus');

            // Null checks for all elements
            if (!tokenInput || !statusEl) {
                console.error('Required elements not found in DOM');
                alert('UI Error: Please reload the plugin');
                return;
            }

            const token = tokenInput.value.trim();

            if (!token) {
                statusEl.textContent = '‚ö†Ô∏è Please enter your Slack Bot Token in the first section';
                statusEl.style.display = 'block';
                statusEl.className = 'user-count';
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ Fetching channels...';
            statusEl.style.display = 'block';
            statusEl.textContent = 'Connecting to Slack...';
            statusEl.className = 'user-count';

            try {
                const response = await fetch(`${SERVER_URL}/api/fetch-slack-channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const result = await response.json();

                if (!result.success) {
                    const errorMsg = result.details ? `${result.error}: ${result.details}` : (result.error || 'Failed to fetch channels');
                    console.error('Slack API error details:', result);
                    throw new Error(errorMsg);
                }

                slackChannels = result.data.channels || [];

                if (slackChannels.length === 0) {
                    throw new Error('No channels found');
                }

                statusEl.textContent = `‚úÖ Successfully fetched ${slackChannels.length} channels!`;
                statusEl.className = 'user-count success';

                // Show channel configuration UI
                document.getElementById('channelsConfig').style.display = 'block';
                renderChannelConfigUI();

                setTimeout(() => {
                    statusEl.textContent = `Configure webhook URLs for the channels you want to use.`;
                }, 2000);

            } catch (error) {
                console.error('Error fetching channels:', error);
                statusEl.textContent = `‚ùå Error: ${error.message}`;
                statusEl.className = 'user-count';

                // Check for specific Slack error codes in the message
                if (error.message.includes('ratelimited')) {
                    statusEl.textContent = '‚è±Ô∏è Rate Limited: Slack API temporarily blocked your requests.\nüí° Please wait 1-2 minutes and try again.';
                } else if (error.message.includes('invalid_auth') || error.message.includes('not_authed')) {
                    statusEl.textContent += '\nüí° Your token is invalid. Please reinstall your Slack app and get a new token.';
                } else if (error.message.includes('missing_scope')) {
                    statusEl.textContent += '\nüí° Add these scopes: channels:read, groups:read, then reinstall your app.';
                } else if (error.message.includes('token_revoked')) {
                    statusEl.textContent += '\nüí° Your token was revoked. Please reinstall your Slack app and get a new token.';
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîÑ Fetch Channels from Slack';
            }
        }

        // Render Channel Configuration UI
        function renderChannelConfigUI() {
            const channelsList = document.getElementById('channelsList');

            let html = '<div style="max-height: 300px; overflow-y: auto;">';

            slackChannels.forEach(channel => {
                const savedWebhook = (channelConfigs[channel.id] && channelConfigs[channel.id].webhook) || '';
                html += `
                    <div style="margin-bottom: 12px; padding: 12px; background: var(--figma-color-bg-secondary, #f8f9fa); border-radius: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 12px;">#${channel.name}</strong>
                            ${channel.is_private ? '<span style="margin-left: 8px; font-size: 10px; color: #6b7280;">üîí Private</span>' : ''}
                        </div>
                        <input
                            type="text"
                            class="input-field"
                            id="webhook_${channel.id}"
                            placeholder="https://hooks.slack.com/services/..."
                            value="${savedWebhook}"
                            style="font-size: 11px; padding: 8px 10px;">
                    </div>
                `;
            });

            html += '</div>';
            channelsList.innerHTML = html;
        }

        // Save Channel Configuration
        async function saveChannelConfig() {
            const newConfigs = {};

            slackChannels.forEach(channel => {
                const webhookInput = document.getElementById(`webhook_${channel.id}`);
                if (webhookInput && webhookInput.value.trim()) {
                    newConfigs[channel.id] = {
                        webhook: webhookInput.value.trim(),
                        name: channel.name,
                        is_private: channel.is_private
                    };
                }
            });

            if (Object.keys(newConfigs).length === 0) {
                alert('Please configure at least one channel webhook URL');
                return;
            }

            channelConfigs = newConfigs;

            // Save to localStorage
            try {
                localStorage.setItem('channelConfigs', JSON.stringify(channelConfigs));
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Save to Figma storage
            parent.postMessage({
                pluginMessage: {
                    type: 'save-channel-configs',
                    data: channelConfigs
                }
            }, '*');

            // Update dropdown
            updateChannelDropdown();
            updateCurrentChannelsCount();

            // Show success message
            const statusEl = document.getElementById('channelsFetchStatus');
            statusEl.textContent = `‚úÖ Saved ${Object.keys(channelConfigs).length} channel configurations!`;
            statusEl.className = 'user-count success';
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Load Channel Configurations
        async function loadChannelConfigs() {
            try {
                // Try localStorage first
                const saved = localStorage.getItem('channelConfigs');
                if (saved) {
                    channelConfigs = JSON.parse(saved);
                    updateChannelDropdown();
                    return;
                }
            } catch (e) {
                console.log('LocalStorage not available');
            }

            // Try Figma storage
            parent.postMessage({ pluginMessage: { type: 'load-channel-configs' } }, '*');
        }

        // Update Channel Dropdown
        function updateChannelDropdown() {
            const dropdown = document.getElementById('slackChannel');

            if (!dropdown) {
                console.log('slackChannel dropdown not found');
                return;
            }

            dropdown.innerHTML = '<option value="">Select a channel...</option>';

            Object.keys(channelConfigs).forEach(channelId => {
                const config = channelConfigs[channelId];
                const option = document.createElement('option');
                option.value = config.webhook;
                option.textContent = `#${config.name}${config.is_private ? ' üîí' : ''}`;
                dropdown.appendChild(option);
            });
        }

        // Update Current Channels Count
        function updateCurrentChannelsCount() {
            const countEl = document.getElementById('currentChannelsCount');
            const warning = document.getElementById('slackChannelsWarning');

            if (!countEl) {
                console.log('currentChannelsCount element not found');
                return;
            }

            const count = Object.keys(channelConfigs).length;

            if (count > 0) {
                const channelNames = Object.values(channelConfigs).map(c => `#${c.name}`).join(', ');
                countEl.textContent = `${count} channel${count > 1 ? 's' : ''} configured: ${channelNames}`;
                countEl.style.color = '#065f46';

                // Hide warning
                if (warning) warning.style.display = 'none';
            } else {
                countEl.textContent = 'No channels configured yet.';
                countEl.style.color = '#dc2626';

                // Show warning
                if (warning) warning.style.display = 'flex';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const settingsModal = document.getElementById('settingsModal');
            const confirmationModal = document.getElementById('confirmationModal');

            if (e.target === settingsModal) {
                closeSettings();
            }

            if (e.target === confirmationModal) {
                closeConfirmation();
            }
        });

        function setupEventListeners() {
            // Keyboard shortcut for submit (Cmd/Ctrl + Enter)
            document.addEventListener('keydown', function(e) {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const submitBtn = document.getElementById('submitBtn');
                    if (!submitBtn.disabled) {
                        commitToSlack();
                    }
                }
            });

            // Task Name validation
            const taskNameInput = document.getElementById('taskName');
            taskNameInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value) {
                    showFieldFeedback('taskName', 'taskNameFeedback', 'Task name is valid', true);
                } else {
                    showFieldFeedback('taskName', 'taskNameFeedback', 'Task name is required', false);
                }
                validateForm();
                updatePreview();
            });

            // ClickUp Link validation
            const clickupInput = document.getElementById('clickupLink');
            clickupInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (!value) {
                    showFieldFeedback('clickupLink', 'clickupLinkFeedback', '');
                } else if (isValidClickUpUrl(value)) {
                    showFieldFeedback('clickupLink', 'clickupLinkFeedback', 'Valid ClickUp link', true);
                } else {
                    showFieldFeedback('clickupLink', 'clickupLinkFeedback', 'Please enter a valid ClickUp URL', false);
                }
                validateForm();
                updatePreview();
            });

            // Figma Link validation
            const figmaInput = document.getElementById('figmaLink');
            figmaInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (!value) {
                    showFieldFeedback('figmaLink', 'figmaLinkFeedback', '');
                } else if (isValidFigmaUrl(value)) {
                    showFieldFeedback('figmaLink', 'figmaLinkFeedback', 'Valid Figma link', true);
                } else {
                    showFieldFeedback('figmaLink', 'figmaLinkFeedback', 'Please enter a valid Figma URL', false);
                }
                validateForm();
                updatePreview();
            });

            // Slack Channel validation
            const slackChannelSelect = document.getElementById('slackChannel');
            slackChannelSelect.addEventListener('change', function() {
                const value = this.value.trim();
                if (value) {
                    showFieldFeedback('slackChannel', 'slackChannelFeedback', 'Channel selected', true);
                } else {
                    showFieldFeedback('slackChannel', 'slackChannelFeedback', 'Please select a channel', false);
                }
                validateForm();
            });

            // Rich text editor
            document.querySelectorAll('.editor-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.execCommand(command, false, null);
                    document.getElementById('descriptionEditor').focus();
                });
            });

            // Tags input for acknowledged by
            const tagInput = document.getElementById('acknowledgedByInput');
            tagInput.addEventListener('input', function(e) {
                showAutocomplete(this.value, 'acknowledged');
            });
            tagInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, 'acknowledged');
            });
            tagInput.addEventListener('blur', function() {
                setTimeout(() => hideAutocomplete('acknowledged'), 200);
            });

            // Click on tags container to focus input
            document.getElementById('acknowledgedByTags').addEventListener('click', function(e) {
                if (e.target === this || e.target.classList.contains('tag-input')) {
                    tagInput.focus();
                }
            });

            // Tags input for CC
            const ccInput = document.getElementById('ccInput');
            ccInput.addEventListener('input', function(e) {
                showAutocomplete(this.value, 'cc');
            });
            ccInput.addEventListener('keydown', function(e) {
                handleAutocompleteKeydown(e, 'cc');
            });
            ccInput.addEventListener('blur', function() {
                setTimeout(() => hideAutocomplete('cc'), 200);
            });

            // Click on CC tags container to focus input
            document.getElementById('ccTags').addEventListener('click', function(e) {
                if (e.target === this || e.target.classList.contains('tag-input')) {
                    ccInput.focus();
                }
            });

            // Server URL change
            document.getElementById('serverUrl').addEventListener('blur', checkServerStatus);

            document.getElementById('descriptionEditor').addEventListener('input', updatePreview);

            // Keyboard shortcuts for rich text editor
            document.getElementById('descriptionEditor').addEventListener('keydown', function(e) {
                // Check for CMD (Mac) or CTRL (Windows/Linux)
                const isMod = e.metaKey || e.ctrlKey;

                if (isMod) {
                    switch(e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            document.execCommand('bold', false, null);
                            break;
                        case 'i':
                            e.preventDefault();
                            document.execCommand('italic', false, null);
                            break;
                        case 'u':
                            e.preventDefault();
                            document.execCommand('underline', false, null);
                            break;
                    }
                }
            });
        }

        function addAcknowledgedBy(username) {
            if (username && !acknowledgedBy.includes(username)) {
                acknowledgedBy.push(username);
                renderAcknowledgedByTags();
                validateForm();
                updatePreview();
                saveAcknowledgments();
            }
        }

        function removeAcknowledgedBy(username) {
            acknowledgedBy = acknowledgedBy.filter(u => u !== username);
            renderAcknowledgedByTags();
            validateForm();
            updatePreview();
        }

        function addCcUser(username) {
            if (username && !ccUsers.includes(username)) {
                ccUsers.push(username);
                renderCcTags();
                updatePreview();
            }
        }

        function removeCcUser(username) {
            ccUsers = ccUsers.filter(u => u !== username);
            renderCcTags();
            updatePreview();
        }

        function renderAcknowledgedByTags() {
            const container = document.getElementById('acknowledgedByTags');
            const input = document.getElementById('acknowledgedByInput');
            
            // Clear existing tags
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before input
            acknowledgedBy.forEach(username => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    @${username}
                    <button type="button" class="tag-remove" onclick="removeAcknowledgedBy('${username}')">&times;</button>
                `;
                container.insertBefore(tag, input);
            });
        }

        function renderCcTags() {
            const container = document.getElementById('ccTags');
            const input = document.getElementById('ccInput');

            // Clear existing tags
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before input
            ccUsers.forEach(username => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    @${username}
                    <button type="button" class="tag-remove" onclick="removeCcUser('${username}')">&times;</button>
                `;
                container.insertBefore(tag, input);
            });
        }

        // Autocomplete functions
        function showAutocomplete(query, type) {
            currentDropdownType = type;
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');

            if (!query.trim()) {
                hideAutocomplete(type);
                return;
            }

            // Filter users based on query
            const queryLower = query.toLowerCase();
            const filteredUsers = slackUsers.filter(user => {
                return user.name.toLowerCase().includes(queryLower) ||
                       user.username.toLowerCase().includes(queryLower) ||
                       (user.email && user.email.toLowerCase().includes(queryLower));
            });

            if (filteredUsers.length === 0) {
                hideAutocomplete(type);
                return;
            }

            // Render dropdown items
            dropdown.innerHTML = filteredUsers.map((user, index) => `
                <div class="autocomplete-item" data-index="${index}" onclick="selectUser('${user.username}', '${type}')">
                    <div class="autocomplete-item-name">${user.name}</div>
                    <div class="autocomplete-item-username">@${user.username}</div>
                    ${user.role ? `<div class="autocomplete-item-role">${user.role}</div>` : ''}
                </div>
            `).join('');

            dropdown.classList.add('show');
            currentFocusIndex = -1;
        }

        function hideAutocomplete(type) {
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');
            dropdown.classList.remove('show');
            currentFocusIndex = -1;
        }

        function handleAutocompleteKeydown(e, type) {
            const dropdown = type === 'acknowledged'
                ? document.getElementById('acknowledgedByDropdown')
                : document.getElementById('ccDropdown');
            const input = type === 'acknowledged'
                ? document.getElementById('acknowledgedByInput')
                : document.getElementById('ccInput');

            if (!dropdown.classList.contains('show')) {
                if (e.key === 'Enter' && input.value.trim()) {
                    e.preventDefault();
                    if (type === 'acknowledged') {
                        addAcknowledgedBy(input.value.trim());
                    } else {
                        addCcUser(input.value.trim());
                    }
                    input.value = '';
                    updatePreview();
                }
                return;
            }

            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentFocusIndex = (currentFocusIndex + 1) % items.length;
                updateAutocompleteSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentFocusIndex = currentFocusIndex <= 0 ? items.length - 1 : currentFocusIndex - 1;
                updateAutocompleteSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocusIndex >= 0 && items[currentFocusIndex]) {
                    items[currentFocusIndex].click();
                } else if (input.value.trim()) {
                    if (type === 'acknowledged') {
                        addAcknowledgedBy(input.value.trim());
                    } else {
                        addCcUser(input.value.trim());
                    }
                    input.value = '';
                    hideAutocomplete(type);
                    updatePreview();
                }
            } else if (e.key === 'Escape') {
                hideAutocomplete(type);
            }
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === currentFocusIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectUser(username, type) {
            if (type === 'acknowledged') {
                addAcknowledgedBy(username);
                document.getElementById('acknowledgedByInput').value = '';
                hideAutocomplete('acknowledged');
            } else {
                addCcUser(username);
                document.getElementById('ccInput').value = '';
                hideAutocomplete('cc');
            }
            updatePreview();
        }

        async function checkServerStatus() {
            const statusLight = document.getElementById('statusLight');
            const statusTooltip = document.getElementById('statusTooltip');

            if (!statusLight || !statusTooltip) {
                console.log('Status elements not found');
                return;
            }

            // Set checking state
            statusLight.className = 'status-light';
            statusTooltip.textContent = 'Checking...';

            try {
                const healthUrl = `${SERVER_URL}/api/send-to-slack`;
                const response = await fetch(healthUrl);

                if (response.ok) {
                    const data = await response.json();
                    if (data.status && data.status.includes('running')) {
                        serverOnline = true;
                        // Update minimal indicator
                        statusLight.className = 'status-light online';
                        statusTooltip.textContent = 'Server online';
                    } else {
                        throw new Error('Invalid response');
                    }
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                serverOnline = false;
                // Update minimal indicator
                statusLight.className = 'status-light offline';
                statusTooltip.textContent = 'Server offline';
            }
        }

        function updatePreview() {
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();
            const description = document.getElementById('descriptionEditor').textContent.trim();

            const commitTypes = {
                feat: 'New feature for',
                fix: 'Bug fix for',
                update: 'Update for',
                final: 'Final design for'
            };

            let preview = '';

            // Checkmarks for final design (show standard emoji in preview)
            if (selectedCommitType === 'final') {
                preview += '<div class="preview-checkmarks">‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ</div>';
            }
            
            // Title - show the task name as clickable link if ClickUp link exists
            let titleDisplay = '';
            if (taskName) {
                if (clickupLink) {
                    titleDisplay = `<span class="preview-link">${taskName}</span>`;
                } else {
                    titleDisplay = taskName;
                }
            } else {
                titleDisplay = '[Task Name]';
            }
            preview += `<div class="preview-title">${commitTypes[selectedCommitType]}:<br>${titleDisplay} ${description || '[Description will appear here]'}</div>`;

            // Figma link - show "Figma file" as clickable link
            let figmaDisplay = '';
            if (figmaLink) {
                figmaDisplay = `<span class="preview-link">Figma file</span>`;
            } else {
                figmaDisplay = 'Figma file';
            }
            preview += `<div class="preview-figma">üé® : ${figmaDisplay}</div>`;

            // Acknowledgments
            let ackText = '';
            if (acknowledgedBy.length > 0) {
                const ackUsers = acknowledgedBy.map(u => `<span class="preview-username">@${u}</span>`).join(' ');
                ackText += `This final design has been acknowledged by ${ackUsers},`;

                // Add CC if present
                if (ccUsers.length > 0) {
                    const ccUsersText = ccUsers.map(u => `<span class="preview-username">@${u}</span>`).join(' ');
                    ackText += ` cc ${ccUsersText}`;
                }
            } else {
                ackText = 'This final design has been acknowledged by: [No acknowledgments yet]';
            }
            
            preview += `<div class="preview-ack">${ackText}</div>`;

            document.getElementById('previewContent').innerHTML = preview;
        }

        function convertHtmlToSlackMarkdown(element) {
            // Clone the element to avoid modifying the original
            const clone = element.cloneNode(true);

            // Convert ordered lists
            const ols = clone.querySelectorAll('ol');
            ols.forEach(ol => {
                const listItems = ol.querySelectorAll('li');
                let listText = '\n';
                listItems.forEach((li, index) => {
                    listText += `${index + 1}. ${li.textContent.trim()}\n`;
                });
                ol.replaceWith(document.createTextNode(listText));
            });

            // Convert unordered lists
            const uls = clone.querySelectorAll('ul');
            uls.forEach(ul => {
                const listItems = ul.querySelectorAll('li');
                let listText = '\n';
                listItems.forEach(li => {
                    listText += `‚Ä¢ ${li.textContent.trim()}\n`;
                });
                ul.replaceWith(document.createTextNode(listText));
            });

            // Convert strikethrough
            const strikes = clone.querySelectorAll('s, strike, del');
            strikes.forEach(s => {
                s.replaceWith(document.createTextNode(`~${s.textContent}~`));
            });

            // Convert bold
            const bolds = clone.querySelectorAll('b, strong');
            bolds.forEach(b => {
                b.replaceWith(document.createTextNode(`*${b.textContent}*`));
            });

            // Convert italic
            const italics = clone.querySelectorAll('i, em');
            italics.forEach(i => {
                i.replaceWith(document.createTextNode(`_${i.textContent}_`));
            });

            // Convert underline (Slack doesn't support underline, so we'll just keep the text)
            const underlines = clone.querySelectorAll('u');
            underlines.forEach(u => {
                u.replaceWith(document.createTextNode(u.textContent));
            });

            return clone.textContent.trim();
        }

        // Show confirmation modal before sending
        function commitToSlack() {
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();
            const description = document.getElementById('descriptionEditor').textContent.trim();
            const slackChannel = document.getElementById('slackChannel').value.trim();

            if (!taskName) {
                showStatus('Please enter a task name', 'error');
                return;
            }

            if (!clickupLink) {
                showStatus('Please enter a ClickUp task link', 'error');
                return;
            }

            if (!figmaLink) {
                showStatus('Please enter a Figma link', 'error');
                return;
            }

            if (!description) {
                showStatus('Please enter a description', 'error');
                return;
            }

            if (!slackChannel) {
                showStatus('Please select a Slack channel', 'error');
                return;
            }

            // Update confirmation preview with same content as main preview
            const previewContent = document.getElementById('previewContent').innerHTML;
            document.getElementById('confirmationPreviewContent').innerHTML = previewContent;

            // Show confirmation modal
            document.getElementById('confirmationModal').classList.add('show');
        }

        // Close confirmation modal
        function closeConfirmation() {
            document.getElementById('confirmationModal').classList.remove('show');
        }

        // Confirm and actually send to Slack
        async function confirmSend() {
            // Close the modal
            closeConfirmation();

            // Now proceed with actual sending
            const taskName = document.getElementById('taskName').value.trim();
            const clickupLink = document.getElementById('clickupLink').value.trim();
            const figmaLink = document.getElementById('figmaLink').value.trim();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üöÄ Sending to Slack...';
            
            showStatus('Sending notification to Slack...', 'loading');

            try {
                // Convert HTML to Slack markdown format
                const descriptionEditor = document.getElementById('descriptionEditor');
                const description = convertHtmlToSlackMarkdown(descriptionEditor);
                const webhookUrl = document.getElementById('slackChannel').value.trim();

                const commitTypes = {
                    feat: 'NEW FEATURE FOR',
                    fix: 'BUG FIX FOR', 
                    update: 'UPDATE FOR',
                    final: 'FINAL DESIGN FOR'
                };

                // Build title with optional ClickUp link
                let titleText = '';
                if (taskName) {
                    if (clickupLink) {
                        // Ensure proper URL format
                        const formattedClickupLink = clickupLink.startsWith('http') ? clickupLink : `https://${clickupLink}`;
                        titleText = `<${formattedClickupLink}|${taskName}>`;
                    } else {
                        titleText = taskName;
                    }
                } else {
                    titleText = '[Task Name Required]';
                }
                
                // Create blocks array for proper Slack formatting
                const blocks = [];
                
                // Add checkmarks and title as header for final design
                const titleWithDescription = description ? `${titleText}\n${description}` : titleText;

                if (selectedCommitType === 'final') {
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `:checklistiyang4::checklistiyang4::checklistiyang4::checklistiyang4::checklistiyang4:\n*${commitTypes[selectedCommitType]}:* ${titleWithDescription}`
                        }
                    });
                } else {
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `*${commitTypes[selectedCommitType]}:*\n${titleWithDescription}`
                        }
                    });
                }
                
                // Add Figma link with default text "Figma file"
                if (figmaLink) {
                    // Ensure proper URL format for Slack: <URL|DisplayText>
                    const formattedFigmaLink = figmaLink.startsWith('http') ? figmaLink : `https://${figmaLink}`;
                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: `üé® : <${formattedFigmaLink}|Figma file>`
                        }
                    });
                }
                
                // Add acknowledgments
                if (acknowledgedBy.length > 0) {
                    const ackUsers = acknowledgedBy.map(u => `<@${u}>`).join(' ');
                    let ackText = `This final design has been acknowledged by: ${ackUsers}`;

                    // Add CC if present
                    if (ccUsers.length > 0) {
                        const ccUsersText = ccUsers.map(u => `<@${u}>`).join(' ');
                        ackText += ` cc: ${ccUsersText}`;
                    }

                    blocks.push({
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: ackText
                        }
                    });
                }

                const payload = {
                    blocks: blocks
                };

                const endpoint = `${SERVER_URL}/api/send-to-slack`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        webhookUrl,
                        payload
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Save acknowledgments for future use
                    saveAcknowledgments();

                    // Show success with animation
                    showStatus('‚úÖ Notification sent successfully!', 'success');
                    submitBtn.textContent = '‚úì Sent Successfully!';
                    submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

                    // Clear form after short delay
                    setTimeout(() => {
                        clearForm();
                        submitBtn.style.background = '';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ Send to Slack';
                }, 2000);
            }
        }

        function clearForm() {
            document.getElementById('taskName').value = '';
            document.getElementById('clickupLink').value = '';
            document.getElementById('figmaLink').value = '';
            document.getElementById('descriptionEditor').textContent = '';
            document.getElementById('slackChannel').value = '';
            acknowledgedBy = [];
            ccUsers = [];
            renderAcknowledgedByTags();
            renderCcTags();

            // Clear field feedback
            showFieldFeedback('taskName', 'taskNameFeedback', '');
            showFieldFeedback('clickupLink', 'clickupLinkFeedback', '');
            showFieldFeedback('figmaLink', 'figmaLinkFeedback', '');
            showFieldFeedback('slackChannel', 'slackChannelFeedback', '');

            updatePreview();
            validateForm();
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Periodic server check
        setInterval(checkServerStatus, 30000);

        // ========================================
        // Welcome Modal Logic
        // ========================================

        let currentWelcomeStep = 1;

        // Check if user has seen welcome
        function checkFirstTimeUser() {
            try {
                const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
                if (!hasSeenWelcome) {
                    // First time user - show welcome modal
                    setTimeout(() => {
                        showWelcomeModal();
                    }, 500); // Small delay for smooth appearance
                }
            } catch (e) {
                console.log('LocalStorage not available for welcome check');
            }
        }

        // Show welcome modal
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            if (modal) {
                modal.classList.add('show');
                currentWelcomeStep = 1;
                showWelcomeStep(1);
            }
        }

        // Hide welcome modal
        function hideWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Show specific welcome step
        function showWelcomeStep(step) {
            // Hide all steps
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`welcomeStep${i}`);
                if (stepEl) {
                    stepEl.style.display = 'none';
                }
            }

            // Show current step
            const currentStepEl = document.getElementById(`welcomeStep${step}`);
            if (currentStepEl) {
                currentStepEl.style.display = 'block';
            }

            currentWelcomeStep = step;
        }

        // Next step
        function nextWelcomeStep() {
            if (currentWelcomeStep < 3) {
                showWelcomeStep(currentWelcomeStep + 1);
            }
        }

        // Previous step
        function previousWelcomeStep() {
            if (currentWelcomeStep > 1) {
                showWelcomeStep(currentWelcomeStep - 1);
            }
        }

        // Skip welcome
        function skipWelcome() {
            closeWelcome();
        }

        // Close welcome and mark as seen
        function closeWelcome() {
            hideWelcomeModal();
            try {
                localStorage.setItem('hasSeenWelcome', 'true');
            } catch (e) {
                console.log('LocalStorage not available');
            }
        }

        // Add option to show welcome again from settings
        function showWelcomeAgain() {
            try {
                localStorage.removeItem('hasSeenWelcome');
            } catch (e) {
                console.log('LocalStorage not available');
            }
            showWelcomeModal();
        }

        // Initialize welcome check on page load
        window.addEventListener('load', () => {
            checkFirstTimeUser();
        });
    </script>
</body>
</html>